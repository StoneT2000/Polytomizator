function hashCoordinate(e,i){return 100*floor(e/hashing_size)+floor(i/hashing_size)}function findIndexFromHash(e){return floor(e/100)+e%100*ceil(cWidth/hashing_size)}function generateHashSpace(){for(verticesHashTable=[],i=0;i<=ceil(cWidth/hashing_size)*ceil(cHeight/hashing_size);i++)verticesHashTable.push([])}function updateHashSpace(e,s,a){var r=findIndexFromHash(hashCoordinate(e,s));if(1==a&&verticesHashTable[r].push([e,s]),0==a)for(i=0;i<verticesHashTable[r].length;i++)verticesHashTable[r][i][0]==e&&verticesHashTable[r][i][1]==s&&verticesHashTable[r].splice(i,1)}function unique_vertex(e,i){for(var s=findIndexFromHash(hashCoordinate(e,i)),a=0;a<verticesHashTable[s].length;a++)if(verticesHashTable[s][a][0]==e&&verticesHashTable[s][a][1]==i)return!1;return!0}function keyPressed(e){if(32===keyCode)downloading=!0,downloading=!1;else if(68===keyCode)triangulize(),finishedColoring=!1,flowerEffect&&(flower_step=0,flowering=!0),image(img1,0,0,cWidth,cHeight),noColors=!1,css_buttons.displayColor(!0),loadPixels(),tColors=[],sTime=millis(),css_buttons.displayPoints(!1),displayPoints=!1;else if(67===keyCode)if(!1===noColors?(noColors=!0,css_buttons.displayColor(!1)):(noColors=!1,css_buttons.displayColor(!0)),flowerEffect);else for(j=0;j<triangulations.length;j++)delaunayDisplay(triangulations[j],triangleCanvasLayer);else 80===keyCode?(mode=1,$("#pointBrush").css("background-color","RGB(140,140,140)"),$("#lineBrush").css("background-color",""),$("#eraser").css("background-color",""),$("#triangleMover").css("background-color","")):69===keyCode?(mode=3,$("#eraser").css("background-color","RGB(140,140,140)"),$("#pointBrush").css("background-color",""),$("#lineBrush").css("background-color",""),$("#triangleMover").css("background-color","")):66===keyCode?(mode=2,$("#lineBrush").css("background-color","RGB(140,140,140)"),$("#pointBrush").css("background-color",""),$("#eraser").css("background-color",""),$("#triangleMover").css("background-color","")):84===keyCode&&(mode=4,$("#triangleMover").css("background-color","RGB(140,140,140)"),$("#pointBrush").css("background-color",""),$("#lineBrush").css("background-color",""),$("#eraser").css("background-color",""))}function mouseClicked(){if(!0===active_canvas&&mouseX<=cWidth&&mouseX>=0&&mouseY<=cHeight&&mouseY>=0){if(1==mode){var e=round(mouseX),i=round(mouseY);1==snapping&&(e-=e%snappingAccuracy,i-=i%snappingAccuracy),unique_vertex(e,i)&&updateHashSpace(e,i,!0)}if(mode,4===mode){var s=triangulations[0];for(k=0;k<s.length;k+=3)if(pointInTriangle(verticesHashTableFlat[s[k]][0],verticesHashTableFlat[s[k]][1],verticesHashTableFlat[s[k+1]][0],verticesHashTableFlat[s[k+1]][1],verticesHashTableFlat[s[k+2]][0],verticesHashTableFlat[s[k+2]][1],mouseX,mouseY))if(tColors[k]>=0)tColors[k]=-1;else if(-1==tColors[k]){var a=[0,0,0];a=averageColor(verticesHashTableFlat[s[k]][0],verticesHashTableFlat[s[k]][1],verticesHashTableFlat[s[k+1]][0],verticesHashTableFlat[s[k+1]][1],verticesHashTableFlat[s[k+2]][0],verticesHashTableFlat[s[k+2]][1],colorAccuracy),tColors[k]=a[0],tColors[k+1]=a[1],tColors[k+2]=a[2]}}recordVertices()}}function erase_vertices(e,i,s){for(var a=floor(round(e)/hashing_size)*hashing_size,r=floor(round(i)/hashing_size)*hashing_size,o=(findIndexFromHash(hashCoordinate(a,r)),[]),n=-ceil(s/hashing_size);n<=ceil(s/hashing_size);n++)for(var t=-ceil(s/hashing_size);t<=ceil(s/hashing_size);t++){var l=a+hashing_size*n,c=r+hashing_size*t;inCanvas(l,c)&&o.push(findIndexFromHash(hashCoordinate(l,c)))}var d=[];for(n=0;n<o.length;n++)for(t=0;t<verticesHashTable[o[n]].length;t++){var h=verticesHashTable[o[n]][t];squaredist(h[0],h[1],e,i)<=s*s&&d.push(h[0],h[1])}for(n=0;n<d.length;n+=2)updateHashSpace(d[n],d[n+1],!1)}function snapVertices(e){for(e||(e=20),in1=0;in1<verticesHashTable.length;in1++)for(in2=0;in2<verticesHashTable[in1].length;in2++){var i=!0,s=!0;verticesHashTable[in1][in2][0]==cWidth&&(i=!1),verticesHashTable[in1][in2][1]==cHeight&&(s=!1),i&&(verticesHashTable[in1][in2][0]%e<e/2?verticesHashTable[in1][in2][0]=verticesHashTable[in1][in2][0]-verticesHashTable[in1][in2][0]%e:verticesHashTable[in1][in2][0]=verticesHashTable[in1][in2][0]+20-verticesHashTable[in1][in2][0]%e),s&&(verticesHashTable[in1][in2][1]%e<e/2?verticesHashTable[in1][in2][1]=verticesHashTable[in1][in2][1]-verticesHashTable[in1][in2][1]%e:verticesHashTable[in1][in2][1]=verticesHashTable[in1][in2][1]+20-verticesHashTable[in1][in2][1]%e)}recordVertices()}function delaunayDisplay(e,i,s,a,r,o){var n=triangulatedVerticesFlat;if(s&&(n=s),0===flower_step&&a){uncoloredTriangleCanvasLayer=createGraphics(cWidth,cHeight),colorIn(),sTime=millis(),!0===displayImage?(i.image(img1,0,0,cWidth,cHeight),uncoloredTriangleCanvasLayer.image(img1,0,0,cWidth,cHeight)):(i.fill(255),i.rect(0,0,cWidth,cHeight),uncoloredTriangleCanvasLayer.fill(255),uncoloredTriangleCanvasLayer.rect(0,0,cWidth,cHeight));for(var t=0;t<e.length;t+=3)i.fill(256,256,256),i.stroke(10,10,10),uncoloredTriangleCanvasLayer.fill(256,256,256),uncoloredTriangleCanvasLayer.stroke(10,10,10),n.length>0&&(i.triangle(n[e[t]][0],n[e[t]][1],n[e[t+1]][0],n[e[t+1]][1],n[e[t+2]][0],n[e[t+2]][1]),uncoloredTriangleCanvasLayer.triangle(n[e[t]][0],n[e[t]][1],n[e[t+1]][0],n[e[t+1]][1],n[e[t+2]][0],n[e[t+2]][1]))}if(a){var l=1;for(o&&(l=o),t=3*r;t<3*r+3*l;t+=3)t<e.length&&(tColors[t]>=0?(i.fill(tColors[t],tColors[t+1],tColors[t+2]),i.stroke(tColors[t],tColors[t+1],tColors[t+2])):(i.fill(256,256,256),i.stroke(10,10,10)),n.length>0&&i.triangle(n[e[t]][0],n[e[t]][1],n[e[t+1]][0],n[e[t+1]][1],n[e[t+2]][0],n[e[t+2]][1]))}else{!0===displayImage?i.image(img1,0,0,cWidth,cHeight):(i.fill(255),i.rect(0,0,cWidth,cHeight));for(t=0;t<e.length;t+=3)if(tColors[t]>=0&&0==noColors?(i.fill(tColors[t],tColors[t+1],tColors[t+2]),i.stroke(tColors[t],tColors[t+1],tColors[t+2])):1==noColors?(i.fill(256,256,256),i.stroke(10,10,10)):-1==tColors[t]?(i.noFill(),i.noStroke()):(i.fill(256,256,256),i.stroke(10,10,10)),n.length>0)if(0==displayMode)i.triangle(n[e[t]][0],n[e[t]][1],n[e[t+1]][0],n[e[t+1]][1],n[e[t+2]][0],n[e[t+2]][1]);else if(1==displayMode){var c=[n[e[t]][0],n[e[t+1]][0],n[e[t+2]][0]],d=[n[e[t]][1],n[e[t+1]][1],n[e[t+2]][1]],h=c[0],u=d[0],g=-1,p=-1;for(xi=0;xi<c.length;xi++)c[xi]<h&&(h=c[xi]),c[xi]>g&&(g=c[xi]),d[xi]<u&&(u=d[xi]),d[xi]>p&&(p=d[xi]);i.rect(h,u,g-h,p-u)}else if(2==displayMode){var v=circumcenter(n[e[t]][0],n[e[t]][1],n[e[t+1]][0],n[e[t+1]][1],n[e[t+2]][0],n[e[t+2]][1]),f=v[0],b=v[1],m=2*sqrt(squaredist(n[e[t]][0],n[e[t]][1],f,b));i.ellipse(f,b,m,m)}else if(3==displayMode)i.triangle(n[e[t]][0],n[e[t]][1],n[e[t+1]][0],n[e[t+1]][1],n[e[t+2]][0],n[e[t+2]][1]),i.triangle(n[e[t]][0]+random(-sd,sd),n[e[t]][1]+random(-sd,sd),n[e[t+1]][0]+random(-sd,sd),n[e[t+1]][1]+random(-sd,sd),n[e[t+2]][0]+random(-sd,sd),n[e[t+2]][1]+random(-sd,sd));else if(4==displayMode){c=[n[e[t]][0],n[e[t+1]][0],n[e[t+2]][0]],d=[n[e[t]][1],n[e[t+1]][1],n[e[t+2]][1]],h=c[0],u=d[0],g=-1,p=-1;for(xi=0;xi<c.length;xi++)c[xi]<h&&(h=c[xi]),c[xi]>g&&(g=c[xi]),d[xi]<u&&(u=d[xi]),d[xi]>p&&(p=d[xi]);i.rect(h,u,g-h,p-u),i.rect(h+random(-sd,sd),u+random(-sd,sd),g-h+random(-sd,sd),p-u+random(-sd,sd))}}}function circumcenter(e,i,s,a,r,o){var n=s-e,t=a-i,l=r-e,c=o-i,d=n*n+t*t,h=l*l+c*c,u=n*c-t*l;return[e+.5*(c*d-t*h)/u,i+.5*(n*h-l*d)/u]}function loadData(e){for(null===e&&alert("No recently saved data"),triangulations=e[0],tColors=e[1],verticesHashTable=e[2],verticesHashTableFlat=e[3],cWidth=e[4],cHeight=e[5],myCanvas=resizeCanvas(cWidth,cHeight),$("#gamedisplay").css("right",(cWidth/2).toString()+"px"),triangulize(),displayPoints=!0,css_buttons.displayPoints(!0),j=0;j<triangulations.length;j++)delaunayDisplay(triangulations[j],triangleCanvasLayer);recordVertices()}function saveData(e){var i="art1";e&&(i=e);var s=[triangulations.slice(),tColors.slice(),verticesHashTable.slice(),verticesHashTableFlat.slice(),cWidth,cHeight];localStorage.setItem(i,JSON.stringify(s))}function expandVertex(e,i){i<1?(i=1/(i*=-1),i++):i--;var s=e[0]-0,a=e[1]-0;return[e[0]+s*i,e[1]+a*i]}function lineAngle(e,i,s,a){var r=0;if(s-e>=0)r=0,a-i>=0&&(r=360);else r=180;return-atan((a-i)/(s-e))+r}function expandImage(e,i){var s=cWidth*e,a=cHeight*e;sd*=e,downloadcanvas=createGraphics(s,a);for(var r=JSON.parse(JSON.stringify(triangulatedVerticesFlat)),o=0;o<r.length;o++){var n=expandVertex(r[o],e);r[o]=n}for(downloadcanvas.noSmooth(),j=0;j<triangulations.length;j++)delaunayDisplay(triangulations[j],downloadcanvas,r);if(1==i){downloading=!0,downloadcanvas.elt.id="downloadthiscanvas";var t=document.getElementById("downloadthiscanvas");t.getContext("2d");t.toBlob(function(e){saveAs(e,"PolyArt.png")}),$("#downloadthiscanvas").remove(),downloading=!1}sd/=e}function triangulize(){var e;verticesHashTableFlat=verticesHashTable.reduce(function(e,i){return e.concat(i)}),e=Delaunator.from(verticesHashTableFlat),stepD=0;var i=e.triangles;triangulations[0]=i,displayTriangulation=!0,css_buttons.displayTriangulation(!0),stepD=0,triangulatedVerticesFlat=JSON.parse(JSON.stringify(verticesHashTableFlat))}function fget(e,i){var s=((i=parseInt(i.toFixed(0)))*d*cWidth+e)*d*4;return[pixels[s],pixels[s+1],pixels[s+2],pixels[s+3]]}function inCanvas(e,i){return!(e>cWidth||e<0||i>cHeight||i<0)}function sign(e,i,s,a,r,o){return(e-r)*(a-o)-(s-r)*(i-o)}function pointInTriangle(e,i,s,a,r,o,n,t){return bc1=sign(n,t,e,i,s,a)<0,bc2=sign(n,t,s,a,r,o)<0,bc3=sign(n,t,r,o,e,i)<0,bc1==bc2&&bc2==bc3}function averageColor(e,s,a,r,o,n,t){var l=[e,a,o],c=[s,r,n],d=l.reduce(function(e,i){return i<=e?i:e}),h=l.reduce(function(e,i){return i>=e?i:e}),u=c.reduce(function(e,i){return i<=e?i:e}),g=c.reduce(function(e,i){return i>=e?i:e});if(1==quickColor)return quickAverageColor(e,s,a,r,o,n);var p=0,v=0,f=0,b=0;for(i=0;i<g-u;i+=t)for(j=0;j<h-d;j+=t)if(pointInTriangle(e,s,a,r,o,n,d+j,u+i)){var m=fget(d+j,u+i);p+=m[0],v+=m[1],f+=m[2],b+=1}return 0==b?quickAverageColor(e,s,a,r,o,n):[p/b,v/b,f/b]}function quickAverageColor(e,i,s,a,r,o){var n=fget(e,i),t=fget(s,a),l=fget(r,o);return[(n[0]+t[0]+l[0])/3,(n[1]+t[1]+l[1])/3,(n[2]+t[2]+l[2])/3]}function squaredist(e,i,s,a){return(s-e)*(s-e)+(a-i)*(a-i)}function autoGenerateArt(){for(0==completedFilters&&(completedFilters=!0,image(img1,0,0,cWidth,cHeight),filter(GRAY),loadPixels(),pixels=changePixels3("smooth",pixels),pixels=changePixels3("edge",pixels)),generateHashSpace(),updateHashSpace(0,0,!0),updateHashSpace(cWidth,0,!0),updateHashSpace(0,cHeight,!0),updateHashSpace(cWidth,cHeight,!0),i=0;i<cWidth/80;i++){var e=80*i+round(random(0,30)),s=80*i+round(random(0,30));inCanvas(e,cHeight)&&updateHashSpace(e,cHeight,!0),inCanvas(s,cHeight)&&updateHashSpace(s,0,!0)}for(i=0;i<cHeight/80;i++){e=80*i+round(random(0,30)),s=80*i+round(random(0,30));inCanvas(cWidth,e)&&updateHashSpace(cWidth,e,!0),inCanvas(0,s)&&updateHashSpace(0,s,!0)}splitSquare(20),generateRandomSquares(20,.4),pushEdgePointsToAll(),triangulize(),finishedColoring=!1,image(img1,0,0,cWidth,cHeight),loadPixels(),tColors=[],css_buttons.displayPoints(!1),displayPoints=!1}function construct_css_buttons(){this.displayPoints=function(e){!1===e?($("#displayPoints").html("Show<br>Points<br>"),$("#displayPoints").css("color","black"),$("#displayPoints").css("background-color","RGB(255,255,255)")):($("#displayPoints").html("Hide<br>Points<br>"),$("#displayPoints").css("color","white"),$("#displayPoints").css("background-color","RGB(40,40,40)"))},this.displayColor=function(e){!1===e?($("#displayColor").html("Show<br>Colors<br>"),$("#displayColor").css("color","black"),$("#displayColor").css("background-color","RGB(255,255,255)")):($("#displayColor").html("Hide<br>Colors<br>"),$("#displayColor").css("color","white"),$("#displayColor").css("background-color","RGB(40,40,40)"))},this.displayTriangulation=function(e){!0===e?($("#displayTriangulation").html("Hide<br>Triangles<br>"),$("#displayTriangulation").css("color","white"),$("#displayTriangulation").css("background-color","RGB(40,40,40)")):($("#displayTriangulation").html("Show<br>Triangles<br>"),$("#displayTriangulation").css("color","black"),$("#displayTriangulation").css("background-color","RGB(255,255,255)"))},this.displayImage=function(e){!0===e?($("#displayImage").html("Hide<br>Image<br>"),$("#displayImage").css("color","white"),$("#displayImage").css("background-color","RGB(40,40,40)")):($("#displayImage").html("Show<br>Image<br>"),$("#displayImage").css("color","black"),$("#displayImage").css("background-color","RGB(255,255,255)"))}}function undo(){indexPos-++stepBackNum<0||stepBackNum>max_undo-1?stepBackNum--:(undoState=1,verticesHashTable=JSON.parse(JSON.stringify(storedVertices[(indexPos-stepBackNum)%max_undo])),verticesHashTableFlat=verticesHashTable.reduce(function(e,i){return e.concat(i)}))}function redo(){--stepBackNum<0?stepBackNum++:(verticesHashTable=JSON.parse(JSON.stringify(storedVertices[(indexPos-stepBackNum)%max_undo])),verticesHashTableFlat=verticesHashTable.reduce(function(e,i){return e.concat(i)}))}function recordVertices(){0==undoState?(indexPos++,storedVertices[indexPos%max_undo]=JSON.parse(JSON.stringify(verticesHashTable)),indexPos>=4*max_undo&&(indexPos=indexPos%max_undo+max_undo)):(storedVertices[0]=JSON.parse(JSON.stringify(storedVertices[(indexPos-stepBackNum)%max_undo])),indexPos=0,stepBackNum=0,undoState=0,indexPos++,storedVertices[indexPos%max_undo]=JSON.parse(JSON.stringify(verticesHashTable)))}var downloadcanvas,testCanvas,hashing_size=50,sd=15,css_buttons=new construct_css_buttons,indexPos=-1,stepBackNum=0,undoState=0;