function hashCoordinate(e,s){return 100*floor(e/hashing_size)+floor(s/hashing_size)}function findIndexFromHash(e){return floor(e/100)+e%100*ceil(cWidth/hashing_size)}function generateHashSpace(){for(verticesHashTable=[],i=0;i<=ceil(cWidth/hashing_size)*ceil(cHeight/hashing_size);i++)verticesHashTable.push([])}function updateHashSpace(e,s,a){var r=findIndexFromHash(hashCoordinate(e,s));if(1==a&&verticesHashTable[r].push([e,s]),0==a)for(i=0;i<verticesHashTable[r].length;i++)verticesHashTable[r][i][0]==e&&verticesHashTable[r][i][1]==s&&verticesHashTable[r].splice(i,1)}function unique_vertex(e,s){for(var i=findIndexFromHash(hashCoordinate(e,s)),a=0;a<verticesHashTable[i].length;a++)if(verticesHashTable[i][a][0]==e&&verticesHashTable[i][a][1]==s)return!1;return!0}function keyPressed(e){if(32===keyCode)downloading=!0,downloading=!1;else if(68===keyCode)triangulate_and_display();else if(67===keyCode)if(!1===noColors?(noColors=!0,css_buttons.displayColor(!1)):(noColors=!1,css_buttons.displayColor(!0)),flowerEffect);else for(j=0;j<triangulations.length;j++)delaunayDisplay(triangulations[j],triangleCanvasLayer);else 80===keyCode?(mode=1,$("#pointBrush").css("background-color","RGB(140,140,140)"),$("#lineBrush").css("background-color",""),$("#eraser").css("background-color",""),$("#triangleMover").css("background-color","")):69===keyCode?(mode=3,$("#eraser").css("background-color","RGB(140,140,140)"),$("#pointBrush").css("background-color",""),$("#lineBrush").css("background-color",""),$("#triangleMover").css("background-color","")):66===keyCode?(mode=2,$("#lineBrush").css("background-color","RGB(140,140,140)"),$("#pointBrush").css("background-color",""),$("#eraser").css("background-color",""),$("#triangleMover").css("background-color","")):84===keyCode&&(mode=4,$("#triangleMover").css("background-color","RGB(140,140,140)"),$("#pointBrush").css("background-color",""),$("#lineBrush").css("background-color",""),$("#eraser").css("background-color",""))}function triangulate_and_display(){triangulize(),finishedColoring=!1,flowerEffect&&(flower_step=0,flowering=!0),image(img1,0,0,cWidth,cHeight),noColors=!1,css_buttons.displayColor(!0),displayPoints=!1,css_buttons.displayPoints(!1),loadPixels(),tColors=[],sTime=millis()}function mouseClicked(){if(!0===active_canvas&&mouseX<=cWidth&&mouseX>=0&&mouseY<=cHeight&&mouseY>=0){if(1==mode){var e=round(mouseX),s=round(mouseY);1==snapping&&(e-=e%snappingAccuracy,s-=s%snappingAccuracy),unique_vertex(e,s)&&updateHashSpace(e,s,!0)}if(mode,4===mode){var i=triangulations[0];for(k=0;k<i.length;k+=3)if(pointInTriangle(verticesHashTableFlat[i[k]][0],verticesHashTableFlat[i[k]][1],verticesHashTableFlat[i[k+1]][0],verticesHashTableFlat[i[k+1]][1],verticesHashTableFlat[i[k+2]][0],verticesHashTableFlat[i[k+2]][1],mouseX,mouseY))if(tColors[k]>=0)tColors[k]=-1;else if(-1==tColors[k]){var a=[0,0,0];a=averageColor(verticesHashTableFlat[i[k]][0],verticesHashTableFlat[i[k]][1],verticesHashTableFlat[i[k+1]][0],verticesHashTableFlat[i[k+1]][1],verticesHashTableFlat[i[k+2]][0],verticesHashTableFlat[i[k+2]][1],colorAccuracy),tColors[k]=a[0],tColors[k+1]=a[1],tColors[k+2]=a[2]}}recordVertices()}}function erase_vertices(e,s,i){for(var a=floor(round(e)/hashing_size)*hashing_size,r=floor(round(s)/hashing_size)*hashing_size,t=(findIndexFromHash(hashCoordinate(a,r)),[]),n=-ceil(i/hashing_size);n<=ceil(i/hashing_size);n++)for(var o=-ceil(i/hashing_size);o<=ceil(i/hashing_size);o++){var l=a+hashing_size*n,c=r+hashing_size*o;inCanvas(l,c)&&t.push(findIndexFromHash(hashCoordinate(l,c)))}var d=[];for(n=0;n<t.length;n++)for(o=0;o<verticesHashTable[t[n]].length;o++){var u=verticesHashTable[t[n]][o];squaredist(u[0],u[1],e,s)<=i*i&&d.push(u[0],u[1])}for(n=0;n<d.length;n+=2)updateHashSpace(d[n],d[n+1],!1)}function snapVertices(e){for(e||(e=20),in1=0;in1<verticesHashTable.length;in1++)for(in2=0;in2<verticesHashTable[in1].length;in2++){var s=!0,i=!0;verticesHashTable[in1][in2][0]==cWidth&&(s=!1),verticesHashTable[in1][in2][1]==cHeight&&(i=!1),s&&(verticesHashTable[in1][in2][0]%e<e/2?verticesHashTable[in1][in2][0]=verticesHashTable[in1][in2][0]-verticesHashTable[in1][in2][0]%e:verticesHashTable[in1][in2][0]=verticesHashTable[in1][in2][0]+20-verticesHashTable[in1][in2][0]%e),i&&(verticesHashTable[in1][in2][1]%e<e/2?verticesHashTable[in1][in2][1]=verticesHashTable[in1][in2][1]-verticesHashTable[in1][in2][1]%e:verticesHashTable[in1][in2][1]=verticesHashTable[in1][in2][1]+20-verticesHashTable[in1][in2][1]%e)}recordVertices()}function delaunayDisplay(e,s,i,a,r,t){var n=triangulatedVerticesFlat;if(i&&(n=i),0===flower_step&&a&&(uncoloredTriangleCanvasLayer=createGraphics(cWidth,cHeight),colorIn(),sTime=millis(),!0===displayImage?(s.image(img1,0,0,cWidth,cHeight),uncoloredTriangleCanvasLayer.image(img1,0,0,cWidth,cHeight)):(s.fill(255),s.rect(0,0,cWidth,cHeight),uncoloredTriangleCanvasLayer.fill(255),uncoloredTriangleCanvasLayer.rect(0,0,cWidth,cHeight)),s.fill(256,256,256),s.stroke(10,10,10),uncoloredTriangleCanvasLayer.fill(256,256,256),uncoloredTriangleCanvasLayer.stroke(10,10,10),n.length>0))for(var o=0;o<e.length;o+=3)construct_shape_from_vertices(n,s,e,o),construct_shape_from_vertices(n,uncoloredTriangleCanvasLayer,e,o);if(a){var l=1;for(t&&(l=t),o=3*r;o<3*r+3*l;o+=3)o<e.length&&(tColors[o]>=0?(s.fill(tColors[o],tColors[o+1],tColors[o+2]),s.stroke(tColors[o],tColors[o+1],tColors[o+2])):(s.fill(256,256,256),s.stroke(10,10,10)),n.length>0&&construct_shape_from_vertices(n,s,e,o))}else{!0===displayImage?s.image(img1,0,0,cWidth,cHeight):(s.fill(255),s.rect(0,0,cWidth,cHeight));var c,d;l=1;a?t&&(c=3*r+3*(l=t)):(d=0,c=e.length);for(o=d;o<c;o+=3)tColors[o]>=0&&0==noColors?(s.fill(tColors[o],tColors[o+1],tColors[o+2]),s.stroke(tColors[o],tColors[o+1],tColors[o+2])):1==noColors?(s.fill(256,256,256),s.stroke(10,10,10)):-1==tColors[o]?(s.noFill(),s.noStroke()):(s.fill(256,256,256),s.stroke(10,10,10)),n.length>0&&construct_shape_from_vertices(n,s,e,o)}}function construct_shape_from_vertices(e,s,i,a){if(0==displayMode)s.triangle(e[i[a]][0],e[i[a]][1],e[i[a+1]][0],e[i[a+1]][1],e[i[a+2]][0],e[i[a+2]][1]);else if(1==displayMode){var r=[e[i[a]][0],e[i[a+1]][0],e[i[a+2]][0]],t=[e[i[a]][1],e[i[a+1]][1],e[i[a+2]][1]],n=r[0],o=t[0],l=-1,c=-1;for(xi=0;xi<r.length;xi++)r[xi]<n&&(n=r[xi]),r[xi]>l&&(l=r[xi]),t[xi]<o&&(o=t[xi]),t[xi]>c&&(c=t[xi]);s.rect(n,o,l-n,c-o)}else if(2==displayMode){var d=circumcenter(e[i[a]][0],e[i[a]][1],e[i[a+1]][0],e[i[a+1]][1],e[i[a+2]][0],e[i[a+2]][1]),u=d[0],h=d[1],g=2*sqrt(squaredist(e[i[a]][0],e[i[a]][1],u,h));s.ellipse(u,h,g,g)}else if(3==displayMode)s.triangle(e[i[a]][0],e[i[a]][1],e[i[a+1]][0],e[i[a+1]][1],e[i[a+2]][0],e[i[a+2]][1]),s.triangle(e[i[a]][0]+random(-sd,sd),e[i[a]][1]+random(-sd,sd),e[i[a+1]][0]+random(-sd,sd),e[i[a+1]][1]+random(-sd,sd),e[i[a+2]][0]+random(-sd,sd),e[i[a+2]][1]+random(-sd,sd));else if(4==displayMode){r=[e[i[a]][0],e[i[a+1]][0],e[i[a+2]][0]],t=[e[i[a]][1],e[i[a+1]][1],e[i[a+2]][1]],n=r[0],o=t[0],l=-1,c=-1;for(xi=0;xi<r.length;xi++)r[xi]<n&&(n=r[xi]),r[xi]>l&&(l=r[xi]),t[xi]<o&&(o=t[xi]),t[xi]>c&&(c=t[xi]);s.rect(n,o,l-n,c-o),s.rect(n+random(-sd,sd),o+random(-sd,sd),l-n+random(-sd,sd),c-o+random(-sd,sd))}}function circumcenter(e,s,i,a,r,t){var n=i-e,o=a-s,l=r-e,c=t-s,d=n*n+o*o,u=l*l+c*c,h=n*c-o*l;return[e+.5*(c*d-o*u)/h,s+.5*(n*u-l*d)/h]}function loadData(e){for(null===e&&alert("No recently saved data"),triangulations=e[0],tColors=e[1],verticesHashTable=e[2],verticesHashTableFlat=e[3],cWidth=e[4],cHeight=e[5],myCanvas=resizeCanvas(cWidth,cHeight),$("#gamedisplay").css("right",(cWidth/2).toString()+"px"),triangulize(),displayPoints=!0,css_buttons.displayPoints(!0),j=0;j<triangulations.length;j++)delaunayDisplay(triangulations[j],triangleCanvasLayer);recordVertices()}function saveData(e){var s="art1";e&&(s=e);var i=[triangulations.slice(),tColors.slice(),verticesHashTable.slice(),verticesHashTableFlat.slice(),cWidth,cHeight];localStorage.setItem(s,JSON.stringify(i))}function expandVertex(e,s){s<1?(s=1/(s*=-1),s++):s--;var i=e[0]-0,a=e[1]-0;return[e[0]+i*s,e[1]+a*s]}function lineAngle(e,s,i,a){var r=0;if(i-e>=0)r=0,a-s>=0&&(r=360);else r=180;return-atan((a-s)/(i-e))+r}function expandImage(e,s){var i=cWidth*e,a=cHeight*e;sd*=e,downloadcanvas=createGraphics(i,a);for(var r=JSON.parse(JSON.stringify(triangulatedVerticesFlat)),t=0;t<r.length;t++){var n=expandVertex(r[t],e);r[t]=n}for(downloadcanvas.noSmooth(),j=0;j<triangulations.length;j++)delaunayDisplay(triangulations[j],downloadcanvas,r);if(1==s){downloading=!0,downloadcanvas.elt.id="downloadthiscanvas";var o=document.getElementById("downloadthiscanvas");o.getContext("2d");o.toBlob(function(e){saveAs(e,"PolyArt.png")}),$("#downloadthiscanvas").remove(),downloading=!1}sd/=e}function triangulize(){var e;verticesHashTableFlat=verticesHashTable.reduce(function(e,s){return e.concat(s)}),e=Delaunator.from(verticesHashTableFlat),stepD=0;var s=e.triangles;triangulations[0]=s,displayTriangulation=!0,css_buttons.displayTriangulation(!0),stepD=0,triangulatedVerticesFlat=JSON.parse(JSON.stringify(verticesHashTableFlat))}function fget(e,s){var i=((s=parseInt(s.toFixed(0)))*d*cWidth+e)*d*4;return[pixels[i],pixels[i+1],pixels[i+2],pixels[i+3]]}function inCanvas(e,s){return!(e>cWidth||e<0||s>cHeight||s<0)}function sign(e,s,i,a,r,t){return(e-r)*(a-t)-(i-r)*(s-t)}function pointInTriangle(e,s,i,a,r,t,n,o){return bc1=sign(n,o,e,s,i,a)<0,bc2=sign(n,o,i,a,r,t)<0,bc3=sign(n,o,r,t,e,s)<0,bc1==bc2&&bc2==bc3}function averageColor(e,s,a,r,t,n,o){var l=[e,a,t],c=[s,r,n],d=l.reduce(function(e,s){return s<=e?s:e}),u=l.reduce(function(e,s){return s>=e?s:e}),h=c.reduce(function(e,s){return s<=e?s:e}),g=c.reduce(function(e,s){return s>=e?s:e});if(1==quickColor)return quickAverageColor(e,s,a,r,t,n);var v=0,f=0,p=0,b=0;for(i=0;i<g-h;i+=o)for(j=0;j<u-d;j+=o)if(pointInTriangle(e,s,a,r,t,n,d+j,h+i)){var m=fget(d+j,h+i);v+=m[0],f+=m[1],p+=m[2],b+=1}return 0==b?quickAverageColor(e,s,a,r,t,n):[v/b,f/b,p/b]}function quickAverageColor(e,s,i,a,r,t){var n=fget(e,s),o=fget(i,a),l=fget(r,t);return[(n[0]+o[0]+l[0])/3,(n[1]+o[1]+l[1])/3,(n[2]+o[2]+l[2])/3]}function squaredist(e,s,i,a){return(i-e)*(i-e)+(a-s)*(a-s)}function construct_css_buttons(){this.displayPoints=function(e){!0===e?($("#displayPoints").removeClass("active"),$("#displayPoints").html("Hide<br>Points")):($("#displayPoints").addClass("active"),$("#displayPoints").html("Show<br>Points"))},this.displayColor=function(e){!0===e?($("#displayColor").removeClass("active"),$("#displayColor").html("Hide<br>Colors")):($("#displayColor").html("Show<br>Colors"),$("#displayColor").addClass("active"))},this.displayTriangulation=function(e){!0===e?($("#displayTriangulation").html("Hide<br>Triangles<br>"),$("#displayTriangulation").removeClass("active")):($("#displayTriangulation").html("Show<br>Triangles<br>"),$("#displayTriangulation").addClass("active"))},this.displayImage=function(e){!0===e?($("#displayImage").removeClass("active"),$("#displayImage").html("Hide<br>Image")):($("#displayImage").html("Show<br>Image"),$("#displayImage").addClass("active"))}}function undo(){indexPos-++stepBackNum<0||stepBackNum>max_undo-1?stepBackNum--:(undoState=1,verticesHashTable=JSON.parse(JSON.stringify(storedVertices[(indexPos-stepBackNum)%max_undo])),verticesHashTableFlat=verticesHashTable.reduce(function(e,s){return e.concat(s)}))}function redo(){--stepBackNum<0?stepBackNum++:(verticesHashTable=JSON.parse(JSON.stringify(storedVertices[(indexPos-stepBackNum)%max_undo])),verticesHashTableFlat=verticesHashTable.reduce(function(e,s){return e.concat(s)}))}function recordVertices(){0==undoState?(indexPos++,storedVertices[indexPos%max_undo]=JSON.parse(JSON.stringify(verticesHashTable)),indexPos>=4*max_undo&&(indexPos=indexPos%max_undo+max_undo)):(storedVertices[0]=JSON.parse(JSON.stringify(storedVertices[(indexPos-stepBackNum)%max_undo])),indexPos=0,stepBackNum=0,undoState=0,indexPos++,storedVertices[indexPos%max_undo]=JSON.parse(JSON.stringify(verticesHashTable)))}var downloadcanvas,testCanvas,hashing_size=50,sd=15,css_buttons=new construct_css_buttons,indexPos=-1,stepBackNum=0,undoState=0;