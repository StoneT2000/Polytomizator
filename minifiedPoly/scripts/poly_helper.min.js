function hashCoordinate(e,a){return 100*floor(e/hashing_size)+floor(a/hashing_size)}function findIndexFromHash(e){return floor(e/100)+e%100*ceil(cWidth/hashing_size)}function generateHashSpace(){totalpoints=0,verticesCanvasLayer.clear(),verticesHashTable=[];for(var e=0;e<=ceil(cWidth/hashing_size+1)*ceil(cHeight/hashing_size+1);e++)verticesHashTable.push([])}function updateHashSpace(e,a,s){var t=findIndexFromHash(hashCoordinate(e,a));if(1==s&&(verticesHashTable[t].push([e,a]),verticesCanvasLayer.ellipse(e,a,5,5),totalpoints++),0==s)for(var i=0;i<verticesHashTable[t].length;i++)if(verticesHashTable[t][i][0]==e&&verticesHashTable[t][i][1]==a){verticesHashTable[t].splice(i,1),totalpoints--;verticesCanvasLayer.elt.getContext("2d").clearRect(e-5,a-5,10,10)}}function draw_all_points(e,a){e.fill(255),e.stroke(1);for(var s=0;s<a.length;s++)for(var t=0;t<a[s].length;t++)e.ellipse(a[s][t][0],a[s][t][1],5,5)}function clear_all_points(e){}function unique_vertex(e,a){for(var s=findIndexFromHash(hashCoordinate(e,a)),t=0;t<verticesHashTable[s].length;t++)if(verticesHashTable[s][t][0]==e&&verticesHashTable[s][t][1]==a)return!1;return!0}function keyPressed(e){if(32===keyCode)downloading=!0,downloading=!1;else if(68===keyCode)triangulate_and_display();else if(67===keyCode)if(!1===noColors?(noColors=!0,css_buttons.displayColor(!1)):(noColors=!1,css_buttons.displayColor(!0)),flowerEffect);else for(var a=0;a<triangulations.length;a++)delaunayDisplay(triangulations[a],triangleCanvasLayer);else 80===keyCode?(mode=1,removeClassFromBrushes("active"),$("#pointBrush").addClass("active")):69===keyCode?(mode=3,removeClassFromBrushes("active"),$("#eraser").addClass("active")):66===keyCode?(mode=2,removeClassFromBrushes("active"),$("#lineBrush").addClass("active")):84===keyCode&&(mode=4,removeClassFromBrushes("active"),$("#triangleMove").addClass("active"))}function triangulate_and_display(){triangulize(),finishedColoring=!1,flowerEffect&&(flower_step=0,flowering=!0),image(img1,0,0,cWidth,cHeight),noColors=!1,css_buttons.displayColor(!0),displayPoints=!1,css_buttons.displayPoints(!1),loadPixels(),tColors=[],sTime=millis()}function mouseClicked(){if(!0===active_canvas&&mouseX<=cWidth&&mouseX>=0&&mouseY<=cHeight&&mouseY>=0){if(1==mode){var e=round(mouseX),a=round(mouseY);1==snapping&&(e%snappingAccuracy<snappingAccuracy/2?e-=e%snappingAccuracy:e=e+snappingAccuracy-e%snappingAccuracy,a%snappingAccuracy<snappingAccuracy/2?a-=a%snappingAccuracy:a=a+snappingAccuracy-a%snappingAccuracy),unique_vertex(e,a)&&updateHashSpace(e,a,!0)}if(mode,4===mode)for(var s=triangulations[0],t=0;t<s.length;t+=3)if(pointInTriangle(verticesHashTableFlat[s[t]][0],verticesHashTableFlat[s[t]][1],verticesHashTableFlat[s[t+1]][0],verticesHashTableFlat[s[t+1]][1],verticesHashTableFlat[s[t+2]][0],verticesHashTableFlat[s[t+2]][1],mouseX,mouseY))if(tColors[t]>=0)tColors[t]=-1;else if(-1==tColors[t]){var i=[0,0,0];i=averageColor(verticesHashTableFlat[s[t]][0],verticesHashTableFlat[s[t]][1],verticesHashTableFlat[s[t+1]][0],verticesHashTableFlat[s[t+1]][1],verticesHashTableFlat[s[t+2]][0],verticesHashTableFlat[s[t+2]][1],colorAccuracy),tColors[t]=i[0],tColors[t+1]=i[1],tColors[t+2]=i[2]}recordVertices()}}function erase_vertices(e,a,s){for(var t=floor(round(e)/hashing_size)*hashing_size,i=floor(round(a)/hashing_size)*hashing_size,r=(findIndexFromHash(hashCoordinate(t,i)),[]),o=-ceil(s/hashing_size);o<=ceil(s/hashing_size);o++)for(var n=-ceil(s/hashing_size);n<=ceil(s/hashing_size);n++){var l=t+hashing_size*o,c=i+hashing_size*n;inCanvas(l,c)&&r.push(findIndexFromHash(hashCoordinate(l,c)))}var d=[];for(o=0;o<r.length;o++)for(n=0;n<verticesHashTable[r[o]].length;n++){var u=verticesHashTable[r[o]][n];squaredist(u[0],u[1],e,a)<=s*s&&d.push(u[0],u[1])}for(o=0;o<d.length;o+=2)updateHashSpace(d[o],d[o+1],!1)}function snapVertices(e){var a=JSON.parse(JSON.stringify(verticesHashTable));generateHashSpace(),e||(e=20);for(var s=0;s<a.length;s++)for(var t=0;t<a[s].length;t++){var i=!0,r=!0,o=a[s][t],n=[o[0],o[1]];o[0]==cWidth&&(i=!1),o[1]==cHeight&&(r=!1),i&&(o[0]%e<e/2?n[0]=o[0]-o[0]%e:n[0]=o[0]+e-o[0]%e),r&&(o[1]%e<e/2?n[1]=o[1]-o[1]%e:n[1]=o[1]+e-o[1]%e),unique_vertex(n[0],n[1])&&updateHashSpace(n[0],n[1],!0)}recordVertices(),verticesCanvasLayer.clear(),draw_all_points(verticesCanvasLayer,verticesHashTable)}function delaunayDisplay(e,a,s,t,i,r){var o=triangulatedVerticesFlat;if(s&&(o=s),0===flower_step&&t&&(uncoloredTriangleCanvasLayer=createGraphics(cWidth,cHeight),colorIn(),sTime=millis(),!0===displayImage?(a.image(img1,0,0,cWidth,cHeight),uncoloredTriangleCanvasLayer.image(img1,0,0,cWidth,cHeight)):(a.fill(255),a.rect(0,0,cWidth,cHeight),uncoloredTriangleCanvasLayer.fill(255),uncoloredTriangleCanvasLayer.rect(0,0,cWidth,cHeight)),a.fill(256,256,256),a.stroke(10,10,10),uncoloredTriangleCanvasLayer.fill(256,256,256),uncoloredTriangleCanvasLayer.stroke(10,10,10),o.length>0))for(var n=0;n<e.length;n+=3)construct_shape_from_vertices(o,a,e,n),construct_shape_from_vertices(o,uncoloredTriangleCanvasLayer,e,n);if(t){var l=1;r&&(l=r);for(n=3*i;n<3*i+3*l;n+=3)n<e.length&&(tColors[n]>=0?(a.fill(tColors[n],tColors[n+1],tColors[n+2]),a.stroke(tColors[n],tColors[n+1],tColors[n+2])):(a.fill(256,256,256),a.stroke(10,10,10)),o.length>0&&construct_shape_from_vertices(o,a,e,n))}else{!0===displayImage?a.image(img1,0,0,cWidth,cHeight):(a.fill(255),a.rect(0,0,cWidth,cHeight));var c,d;l=1;t?r&&(c=3*i+3*(l=r)):(d=0,c=e.length);for(n=d;n<c;n+=3)tColors[n]>=0&&0==noColors?(a.fill(tColors[n],tColors[n+1],tColors[n+2]),a.stroke(tColors[n],tColors[n+1],tColors[n+2])):1==noColors?(a.fill(256,256,256),a.stroke(10,10,10)):-1==tColors[n]?(a.noFill(),a.noStroke()):(a.fill(256,256,256),a.stroke(10,10,10)),o.length>0&&construct_shape_from_vertices(o,a,e,n)}}function construct_shape_from_vertices(e,a,s,t){if(0==displayMode)a.triangle(e[s[t]][0],e[s[t]][1],e[s[t+1]][0],e[s[t+1]][1],e[s[t+2]][0],e[s[t+2]][1]);else if(1==displayMode){for(var i=[e[s[t]][0],e[s[t+1]][0],e[s[t+2]][0]],r=[e[s[t]][1],e[s[t+1]][1],e[s[t+2]][1]],o=i[0],n=r[0],l=-1,c=-1,d=0;d<i.length;d++)i[d]<o&&(o=i[d]),i[d]>l&&(l=i[d]),r[d]<n&&(n=r[d]),r[d]>c&&(c=r[d]);a.rect(o,n,l-o,c-n)}else if(2==displayMode){var u=circumcenter(e[s[t]][0],e[s[t]][1],e[s[t+1]][0],e[s[t+1]][1],e[s[t+2]][0],e[s[t+2]][1]),h=u[0],v=u[1],g=2*sqrt(squaredist(e[s[t]][0],e[s[t]][1],h,v));a.ellipse(h,v,g,g)}else if(3==displayMode)a.triangle(e[s[t]][0],e[s[t]][1],e[s[t+1]][0],e[s[t+1]][1],e[s[t+2]][0],e[s[t+2]][1]),a.triangle(e[s[t]][0]+random(-sd,sd),e[s[t]][1]+random(-sd,sd),e[s[t+1]][0]+random(-sd,sd),e[s[t+1]][1]+random(-sd,sd),e[s[t+2]][0]+random(-sd,sd),e[s[t+2]][1]+random(-sd,sd));else if(4==displayMode){for(i=[e[s[t]][0],e[s[t+1]][0],e[s[t+2]][0]],r=[e[s[t]][1],e[s[t+1]][1],e[s[t+2]][1]],o=i[0],n=r[0],l=-1,c=-1,d=0;d<i.length;d++)i[d]<o&&(o=i[d]),i[d]>l&&(l=i[d]),r[d]<n&&(n=r[d]),r[d]>c&&(c=r[d]);a.rect(o,n,l-o,c-n),a.rect(o+random(-sd,sd),n+random(-sd,sd),l-o+random(-sd,sd),c-n+random(-sd,sd))}}function circumcenter(e,a,s,t,i,r){var o=s-e,n=t-a,l=i-e,c=r-a,d=o*o+n*n,u=l*l+c*c,h=o*c-n*l;return[e+.5*(c*d-n*u)/h,a+.5*(o*u-l*d)/h]}function loadData(e){null===e&&alert("No recently saved data"),triangulations=e[0],tColors=e[1],verticesHashTable=e[2],verticesHashTableFlat=e[3],cWidth=e[4],cHeight=e[5],myCanvas=resizeCanvas(cWidth,cHeight),$("#gamedisplay").css("width",cWidth),$("#gamedisplay").css("margin-left",-cWidth/2),triangulize(),displayPoints=!0,css_buttons.displayPoints(!0);for(var a=0;a<triangulations.length;a++)delaunayDisplay(triangulations[a],triangleCanvasLayer);recordVertices(),verticesCanvasLayer.clear(),draw_all_points(verticesCanvasLayer,verticesHashTable)}function saveData(e){var a="art1";e&&(a=e);var s=[triangulations.slice(),tColors.slice(),verticesHashTable.slice(),verticesHashTableFlat.slice(),cWidth,cHeight];localStorage.setItem(a,JSON.stringify(s))}function expandVertex(e,a){return[e[0]*a,e[1]*a]}function lineAngle(e,a,s,t){var i=0;if(s-e>=0)i=0,t-a>=0&&(i=360);else i=180;return-atan((t-a)/(s-e))+i}function expandImage(e,a){var s=cWidth*e,t=cHeight*e;sd*=e,downloadcanvas=createGraphics(s,t);for(var i=JSON.parse(JSON.stringify(triangulatedVerticesFlat)),r=0;r<i.length;r++){var o=expandVertex(i[r],e);i[r]=o}downloadcanvas.noSmooth();for(var n=0;n<triangulations.length;n++)delaunayDisplay(triangulations[n],downloadcanvas,i);if(1==a){downloading=!0,downloadcanvas.elt.id="downloadthiscanvas";var l=document.getElementById("downloadthiscanvas");l.getContext("2d");l.toBlob(function(e){saveAs(e,"PolyArt.png")}),$("#downloadthiscanvas").remove(),downloading=!1,console.log("Finished downloading")}sd/=e}function triangulize(){verticesHashTableFlat=verticesHashTable.reduce(function(e,a){return e.concat(a)});var e=Delaunator.from(verticesHashTableFlat).triangles;triangulations[0]=e,displayTriangulation=!0,css_buttons.displayTriangulation(!0),triangulatedVerticesFlat=JSON.parse(JSON.stringify(verticesHashTableFlat))}function fget(e,a){var s=((a=parseInt(a.toFixed(0)))*d*cWidth+e)*d*4;return[pixels[s],pixels[s+1],pixels[s+2],pixels[s+3]]}function inCanvas(e,a){return!(e>cWidth||e<0||a>cHeight||a<0)}function sign(e,a,s,t,i,r){return(e-i)*(t-r)-(s-i)*(a-r)}function pointInTriangle(e,a,s,t,i,r,o,n){return bc1=sign(o,n,e,a,s,t)<0,bc2=sign(o,n,s,t,i,r)<0,bc3=sign(o,n,i,r,e,a)<0,bc1==bc2&&bc2==bc3}function averageColor(e,a,s,t,i,r,o){var n=[e,s,i],l=[a,t,r],c=n.reduce(function(e,a){return a<=e?a:e}),d=n.reduce(function(e,a){return a>=e?a:e}),u=l.reduce(function(e,a){return a<=e?a:e}),h=l.reduce(function(e,a){return a>=e?a:e});if(1==quickColor)return quickAverageColor(e,a,s,t,i,r);for(var v=0,g=0,p=0,f=0,m=0;m<h-u;m+=o)for(var C=0;C<d-c;C+=o)if(pointInTriangle(e,a,s,t,i,r,c+C,u+m)){var y=fget(c+C,u+m);v+=y[0],g+=y[1],p+=y[2],f+=1}return 0==f?quickAverageColor(e,a,s,t,i,r):[v/f,g/f,p/f]}function quickAverageColor(e,a,s,t,i,r){var o=fget(e,a),n=fget(s,t),l=fget(i,r);return[(o[0]+n[0]+l[0])/3,(o[1]+n[1]+l[1])/3,(o[2]+n[2]+l[2])/3]}function squaredist(e,a,s,t){return(s-e)*(s-e)+(t-a)*(t-a)}function construct_css_buttons(){this.displayPoints=function(e){!0===e?($("#displayPoints").removeClass("active"),$("#displayPoints").html("Hide<br>Points")):($("#displayPoints").addClass("active"),$("#displayPoints").html("Show<br>Points"))},this.displayColor=function(e){!0===e?($("#displayColor").removeClass("active"),$("#displayColor").html("Hide<br>Colors")):($("#displayColor").html("Show<br>Colors"),$("#displayColor").addClass("active"))},this.displayTriangulation=function(e){!0===e?($("#displayTriangulation").html("Hide<br>Triangles<br>"),$("#displayTriangulation").removeClass("active")):($("#displayTriangulation").html("Show<br>Triangles<br>"),$("#displayTriangulation").addClass("active"))},this.displayImage=function(e){!0===e?($("#displayImage").removeClass("active"),$("#displayImage").html("Hide<br>Image")):($("#displayImage").html("Show<br>Image"),$("#displayImage").addClass("active"))}}function undo(){indexPos-++stepBackNum<=0||stepBackNum>=max_undo-1||stepBackNum>=maxStepBackDist?($("#undo").addClass("disabled"),$("#undo").css("cursor","not-allowed"),$("#redo").removeClass("disabled"),$("#redo").css("cursor","pointer")):($("#undo").removeClass("disabled"),$("#undo").css("cursor","pointer"),$("#redo").removeClass("disabled"),$("#redo").css("cursor","pointer")),indexPos-stepBackNum<0||stepBackNum>max_undo-1||stepBackNum>maxStepBackDist?stepBackNum--:(undoState=1,verticesHashTable=JSON.parse(JSON.stringify(storedVertices[(indexPos-stepBackNum)%max_undo][0])),totalpoints=storedVertices[(indexPos-stepBackNum)%max_undo][1],verticesHashTableFlat=verticesHashTable.reduce(function(e,a){return e.concat(a)}),verticesCanvasLayer.clear(),draw_all_points(verticesCanvasLayer,verticesHashTable))}function redo(){if(--stepBackNum<=0?($("#redo").addClass("disabled"),$("#redo").css("cursor","not-allowed"),$("#undo").removeClass("disabled"),$("#undo").css("cursor","pointer")):($("#redo").removeClass("disabled"),$("#redo").css("cursor","pointer"),$("#undo").removeClass("disabled"),$("#undo").css("cursor","pointer")),stepBackNum<0)return stepBackNum++,void(undoState=0);verticesHashTable=JSON.parse(JSON.stringify(storedVertices[(indexPos-stepBackNum)%max_undo][0])),totalpoints=storedVertices[(indexPos-stepBackNum)%max_undo][1],verticesHashTableFlat=verticesHashTable.reduce(function(e,a){return e.concat(a)}),verticesCanvasLayer.clear(),draw_all_points(verticesCanvasLayer,verticesHashTable)}function recordVertices(){0==undoState?(indexPos++,storedVertices[indexPos%max_undo][0]=JSON.parse(JSON.stringify(verticesHashTable)),storedVertices[indexPos%max_undo][1]=totalpoints,indexPos>=4*max_undo&&(indexPos=indexPos%max_undo+max_undo),maxStepBackDist>=50||maxStepBackDist++,$("#undo").removeClass("disabled"),$("#undo").css("cursor","pointer"),$("#redo").addClass("disabled"),$("#redo").css("cursor","not-allowed")):($("#redo").addClass("disabled"),$("#redo").css("cursor","not-allowed"),$("#undo").removeClass("disabled"),$("#undo").css("cursor","pointer"),indexPos-=stepBackNum,maxStepBackDist=max_undo-stepBackNum,stepBackNum=0,undoState=0,indexPos++,storedVertices[indexPos%max_undo][0]=JSON.parse(JSON.stringify(verticesHashTable)),storedVertices[indexPos%max_undo][1]=totalpoints)}function resize_poly_canvas(e){cWidth=floor(cWidth*e),cHeight=floor(cHeight*e),triangleCanvasLayer=createGraphics(cWidth,cHeight),verticesCanvasLayer=createGraphics(cWidth,cHeight),resizeCanvas(cWidth,cHeight),$("#gamedisplay").css("width",cWidth),$("#gamedisplay").css("margin-left",-cWidth/2),cWidth>.9*window.innerWidth?$("body").width(cWidth+100):$("body").css("width","auto"),verticesHashTableFlat=verticesHashTable.reduce(function(e,a){return e.concat(a)});var a=JSON.parse(JSON.stringify(verticesHashTableFlat));generateHashSpace();for(var s=0;s<a.length;s++){var t=expandVertex(a[s],e);a[s]=t,updateHashSpace(floor(t[0]),floor(t[1]),!0)}completedFilters=!1}var downloadcanvas,testCanvas,origcWidth,origcHeight,hashing_size=50,sd=15,css_buttons=new construct_css_buttons,maxStepBackDist=0,indexPos=-1,stepBackNum=0,undoState=0,canvasScale=1;