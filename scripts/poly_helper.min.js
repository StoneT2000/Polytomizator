function hashCoordinate(e,s){return 100*floor(e/50)+floor(s/50)}function findIndexFromHash(e){return floor(e/100)+e%100*ceil(cWidth/50)}function generateHashSpace(){for(verticesHashTable=[],i=0;i<=ceil(cWidth/50)*ceil(cHeight/50);i++)verticesHashTable.push([]);for(i=0;i<allVertices.length;i++){var e=findIndexFromHash(hashCoordinate(allVertices[i][0],allVertices[i][1]));verticesHashTable[e].push([allVertices[i][0],allVertices[i][1]])}}function updateHashSpace(e,s,a){var r=findIndexFromHash(hashCoordinate(e,s));if(1==a&&verticesHashTable[r].push([e,s]),0==a)for(i=0;i<verticesHashTable[r].length;i++)verticesHashTable[r][i][0]==e&&verticesHashTable[r][i][1]==s&&verticesHashTable[r].splice(i,1)}function unique_vertex(e,s){for(var i=findIndexFromHash(hashCoordinate(e,s)),a=0;a<verticesHashTable[i].length;a++)if(verticesHashTable[i][a][0]==e&&verticesHashTable[i][a][1]==s)return!1;return!0}function keyPressed(e){if(32===keyCode)downloading=!0,downloading=!1;else if(68===keyCode)triangulize(),finishedColoring=!1,image(img1,0,0,cWidth,cHeight),noColors=!1,css_buttons.displayColor(!0),loadPixels(),tColors=[],sTime=millis(),css_buttons.displayPoints(!1),displayPoints=!1;else if(67===keyCode)for(!1===noColors?(noColors=!0,css_buttons.displayColor(!1)):(noColors=!1,css_buttons.displayColor(!0)),j=0;j<triangulations.length;j++)delaunayDisplay(triangulations[j],triangleCanvasLayer);else 80===keyCode?(mode=1,$("#pointBrush").css("background-color","RGB(140,140,140)"),$("#lineBrush").css("background-color",""),$("#eraser").css("background-color",""),$("#triangleMover").css("background-color","")):69===keyCode?(mode=3,$("#eraser").css("background-color","RGB(140,140,140)"),$("#pointBrush").css("background-color",""),$("#lineBrush").css("background-color",""),$("#triangleMover").css("background-color","")):66===keyCode?(mode=2,$("#lineBrush").css("background-color","RGB(140,140,140)"),$("#pointBrush").css("background-color",""),$("#eraser").css("background-color",""),$("#triangleMover").css("background-color","")):84===keyCode&&(mode=4,$("#triangleMover").css("background-color","RGB(140,140,140)"),$("#pointBrush").css("background-color",""),$("#lineBrush").css("background-color",""),$("#eraser").css("background-color",""))}function mouseClicked(){if(mouseX<=cWidth&&mouseX>=0&&mouseY<=cHeight&&mouseY>=0){if(1==mode){var e=round(mouseX),s=round(mouseY);1==snapping&&(e-=e%snappingAccuracy,s-=s%snappingAccuracy),unique_vertex(e,s)&&(allVertices.push([e,s]),updateHashSpace(e,s,!0))}if(mode,4===mode){var i=triangulations[0];for(k=0;k<i.length;k+=3)if(pointInTriangle(verticesHashTableFlat[i[k]][0],verticesHashTableFlat[i[k]][1],verticesHashTableFlat[i[k+1]][0],verticesHashTableFlat[i[k+1]][1],verticesHashTableFlat[i[k+2]][0],verticesHashTableFlat[i[k+2]][1],mouseX,mouseY))if(tColors[k]>=0)tColors[k]=-1;else if(-1==tColors[k]){var a=[0,0,0];a=averageColor(verticesHashTableFlat[i[k]][0],verticesHashTableFlat[i[k]][1],verticesHashTableFlat[i[k+1]][0],verticesHashTableFlat[i[k+1]][1],verticesHashTableFlat[i[k+2]][0],verticesHashTableFlat[i[k+2]][1],colorAccuracy),tColors[k]=a[0],tColors[k+1]=a[1],tColors[k+2]=a[2]}}recordVertices()}}function snapVertices(e){for(e||(e=20),in1=0;in1<verticesHashTable.length;in1++)for(in2=0;in2<verticesHashTable[in1].length;in2++){var s=!0,i=!0;verticesHashTable[in1][in2][0]==cWidth&&(s=!1),verticesHashTable[in1][in2][1]==cHeight&&(i=!1),s&&(verticesHashTable[in1][in2][0]%e<e/2?verticesHashTable[in1][in2][0]=verticesHashTable[in1][in2][0]-verticesHashTable[in1][in2][0]%e:verticesHashTable[in1][in2][0]=verticesHashTable[in1][in2][0]+20-verticesHashTable[in1][in2][0]%e),i&&(verticesHashTable[in1][in2][1]%e<e/2?verticesHashTable[in1][in2][1]=verticesHashTable[in1][in2][1]-verticesHashTable[in1][in2][1]%e:verticesHashTable[in1][in2][1]=verticesHashTable[in1][in2][1]+20-verticesHashTable[in1][in2][1]%e)}}function delaunayDisplay(e,s,i){var a=verticesHashTableFlat;i&&(a=i);for(var r=0;r<e.length;r+=3)if(tColors[r]>=0&&0==noColors?(s.fill(tColors[r],tColors[r+1],tColors[r+2]),s.stroke(tColors[r],tColors[r+1],tColors[r+2])):1==noColors?(s.fill(256,256,256),s.stroke(10,10,10)):-1==tColors[r]?(s.noFill(),s.noStroke()):(s.fill(256,256,256),s.stroke(10,10,10)),a.length>0)if(0==displayMode)s.triangle(a[e[r]][0],a[e[r]][1],a[e[r+1]][0],a[e[r+1]][1],a[e[r+2]][0],a[e[r+2]][1]);else if(1==displayMode){var o=[a[e[r]][0],a[e[r+1]][0],a[e[r+2]][0]],t=[a[e[r]][1],a[e[r+1]][1],a[e[r+2]][1]],n=o[0],l=t[0],c=-1,d=-1;for(xi=0;xi<o.length;xi++)o[xi]<n&&(n=o[xi]),o[xi]>c&&(c=o[xi]),t[xi]<l&&(l=t[xi]),t[xi]>d&&(d=t[xi]);s.rect(n,l,c-n,d-l)}else if(2==displayMode){var u=circumcenter(a[e[r]][0],a[e[r]][1],a[e[r+1]][0],a[e[r+1]][1],a[e[r+2]][0],a[e[r+2]][1]),h=u[0],g=u[1],p=2*sqrt(squaredist(a[e[r]][0],a[e[r]][1],h,g));s.ellipse(h,g,p,p)}else if(3==displayMode)s.triangle(a[e[r]][0],a[e[r]][1],a[e[r+1]][0],a[e[r+1]][1],a[e[r+2]][0],a[e[r+2]][1]),s.triangle(a[e[r]][0]+random(-sd,sd),a[e[r]][1]+random(-sd,sd),a[e[r+1]][0]+random(-sd,sd),a[e[r+1]][1]+random(-sd,sd),a[e[r+2]][0]+random(-sd,sd),a[e[r+2]][1]+random(-sd,sd));else if(4==displayMode){o=[a[e[r]][0],a[e[r+1]][0],a[e[r+2]][0]],t=[a[e[r]][1],a[e[r+1]][1],a[e[r+2]][1]],n=o[0],l=t[0],c=-1,d=-1;for(xi=0;xi<o.length;xi++)o[xi]<n&&(n=o[xi]),o[xi]>c&&(c=o[xi]),t[xi]<l&&(l=t[xi]),t[xi]>d&&(d=t[xi]);s.rect(n,l,c-n,d-l),s.rect(n+random(-sd,sd),l+random(-sd,sd),c-n+random(-sd,sd),d-l+random(-sd,sd))}}function circumcenter(e,s,i,a,r,o){var t=i-e,n=a-s,l=r-e,c=o-s,d=t*t+n*n,u=l*l+c*c,h=t*c-n*l;return[e+.5*(c*d-n*u)/h,s+.5*(t*u-l*d)/h]}function loadData(e){for(null===e&&alert("No recently saved data"),allVertices=e[0],triangulations=e[1],tColors=e[2],verticesHashTable=e[3],verticesHashTableFlat=e[4],triangulize(),displayPoints=!0,css_buttons.displayPoints(!0),j=0;j<triangulations.length;j++)delaunayDisplay(triangulations[j],triangleCanvasLayer);recordVertices()}function saveData(){var e=[allVertices.slice(),triangulations.slice(),tColors.slice(),verticesHashTable.slice(),verticesHashTableFlat.slice()];localStorage.setItem("art1",JSON.stringify(e))}function expandVertex(e,s){s<1?(s=1/(s*=-1),s++):s--;var i=e[0]-0,a=e[1]-0;return[e[0]+i*s,e[1]+a*s]}function lineAngle(e,s,i,a){var r=0;if(i-e>=0)r=0,a-s>=0&&(r=360);else r=180;return-atan((a-s)/(i-e))+r}function expandImage(e,s){expandedWidth=cWidth*e,expandedHeight=cHeight*e;var i=createGraphics(expandedWidth,expandedHeight);for(expandedVerticesHashTable=JSON.parse(JSON.stringify(verticesHashTable)),p=0;p<expandedVerticesHashTable.length;p++)for(l=0;l<expandedVerticesHashTable[p].length;l++){var a=expandVertex(expandedVerticesHashTable[p][l],e);expandedVerticesHashTable[p][l]=a}for(expandedVerticesHashTableFlat=expandedVerticesHashTable.reduce(function(e,s){return e.concat(s)}),j=0;j<triangulations.length;j++)delaunayDisplay(triangulations[j],i,expandedVerticesHashTableFlat);if(1==s){downloading=!0,i.elt.id="downloadthiscanvas";var r=document.getElementById("downloadthiscanvas");r.getContext("2d");r.toBlob(function(e){saveAs(e,"PolyArt.png")}),downloading=!1}}function triangulize(){var e;verticesHashTableFlat=verticesHashTable.reduce(function(e,s){return e.concat(s)}),e=Delaunator.from(verticesHashTableFlat),stepD=0;var s=e.triangles;triangulations[0]=s,displayTriangulation=!0,css_buttons.displayTriangulation(!0),stepD=0}function fget(e,s){var i=((s=parseInt(s.toFixed(0)))*d*cWidth+e)*d*4;return[pixels[i],pixels[i+1],pixels[i+2],pixels[i+3]]}function inCanvas(e,s){return!(e>cWidth||e<0||s>cHeight||s<0)}function sign(e,s,i,a,r,o){return(e-r)*(a-o)-(i-r)*(s-o)}function pointInTriangle(e,s,i,a,r,o,t,n){return bc1=sign(t,n,e,s,i,a)<0,bc2=sign(t,n,i,a,r,o)<0,bc3=sign(t,n,r,o,e,s)<0,bc1==bc2&&bc2==bc3}function averageColor(e,s,a,r,o,t,n){var l=[e,a,o],c=[s,r,t],d=l.reduce(function(e,s){return s<=e?s:e}),u=l.reduce(function(e,s){return s>=e?s:e}),h=c.reduce(function(e,s){return s<=e?s:e}),g=c.reduce(function(e,s){return s>=e?s:e});if(1==quickColor)return quickAverageColor(e,s,a,r,o,t);var p=0,b=0,v=0,f=0;for(i=0;i<g-h;i+=n)for(j=0;j<u-d;j+=n)if(pointInTriangle(e,s,a,r,o,t,d+j,h+i)){var H=fget(d+j,h+i);p+=H[0],b+=H[1],v+=H[2],f+=1}return 0==f?quickAverageColor(e,s,a,r,o,t):[p/f,b/f,v/f]}function quickAverageColor(e,s,i,a,r,o){var t=fget(e,s),n=fget(i,a),l=fget(r,o);return[(t[0]+n[0]+l[0])/3,(t[1]+n[1]+l[1])/3,(t[2]+n[2]+l[2])/3]}function squaredist(e,s,i,a){return(i-e)*(i-e)+(a-s)*(a-s)}function autoGenerateArt(){for(0==completedFilters&&(completedFilters=!0,image(img1,0,0,cWidth,cHeight),filter(GRAY),loadPixels(),pixels=changePixels3("smooth",pixels),pixels=changePixels3("edge",pixels)),allVertices=[],allVertices.push([0,0]),allVertices.push([cWidth,0]),allVertices.push([0,cHeight]),allVertices.push([cWidth,cHeight]),i=0;i<cWidth/80;i++){var e=80*i+round(random(0,30)),s=80*i+round(random(0,30));inCanvas(e,cHeight)&&allVertices.push([e,cHeight]),inCanvas(s,cHeight)&&allVertices.push([s,0])}for(i=0;i<cHeight/80;i++){e=80*i+round(random(0,30)),s=80*i+round(random(0,30));inCanvas(cWidth,e)&&allVertices.push([cWidth,e]),inCanvas(0,s)&&allVertices.push([0,s])}splitSquare(20),generateRandomSquares(20,.4),pushEdgePointsToAll(),triangulize(),finishedColoring=!1,image(img1,0,0,cWidth,cHeight),loadPixels(),tColors=[],css_buttons.displayPoints(!1),displayPoints=!1}function construct_css_buttons(){this.displayPoints=function(e){!1===e?($("#displayPoints").html("Show<br>Points<br>"),$("#displayPoints").css("color","black"),$("#displayPoints").css("background-color","RGB(255,255,255)")):($("#displayPoints").html("Hide<br>Points<br>"),$("#displayPoints").css("color","white"),$("#displayPoints").css("background-color","RGB(40,40,40)"))},this.displayColor=function(e){!1===e?($("#displayColor").html("Show<br>Colors<br>"),$("#displayColor").css("color","black"),$("#displayColor").css("background-color","RGB(255,255,255)")):($("#displayColor").html("Hide<br>Colors<br>"),$("#displayColor").css("color","white"),$("#displayColor").css("background-color","RGB(40,40,40)"))},this.displayTriangulation=function(e){!0===e?($("#displayTriangulation").html("Hide<br>Triangles<br>"),$("#displayTriangulation").css("color","white"),$("#displayTriangulation").css("background-color","RGB(40,40,40)")):($("#displayTriangulation").html("Show<br>Triangles<br>"),$("#displayTriangulation").css("color","black"),$("#displayTriangulation").css("background-color","RGB(255,255,255)"))},this.displayImage=function(e){!0===e?($("#displayImage").html("Hide<br>Image<br>"),$("#displayImage").css("color","white"),$("#displayImage").css("background-color","RGB(40,40,40)")):($("#displayImage").html("Show<br>Image<br>"),$("#displayImage").css("color","black"),$("#displayImage").css("background-color","RGB(255,255,255)"))}}function undo(){indexPos-++stepBackNum<0||stepBackNum>max_undo-1?stepBackNum--:(undoState=1,verticesHashTable=JSON.parse(JSON.stringify(storedVertices[(indexPos-stepBackNum)%max_undo])),verticesHashTableFlat=verticesHashTable.reduce(function(e,s){return e.concat(s)}))}function redo(){--stepBackNum<0?stepBackNum++:(verticesHashTable=JSON.parse(JSON.stringify(storedVertices[(indexPos-stepBackNum)%max_undo])),verticesHashTableFlat=verticesHashTable.reduce(function(e,s){return e.concat(s)}))}function recordVertices(){0==undoState?(indexPos++,storedVertices[indexPos%max_undo]=JSON.parse(JSON.stringify(verticesHashTable)),indexPos>=4*max_undo&&(indexPos=indexPos%max_undo+max_undo)):(storedVertices[0]=JSON.parse(JSON.stringify(storedVertices[(indexPos-stepBackNum)%max_undo])),indexPos=0,stepBackNum=0,undoState=0,indexPos++,storedVertices[indexPos%max_undo]=JSON.parse(JSON.stringify(verticesHashTable)))}var testCanvas,sd=5,css_buttons=new construct_css_buttons,indexPos=-1,stepBackNum=0,undoState=0;