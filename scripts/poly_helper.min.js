function hashCoordinate(e,a){return 100*floor(e/hashing_size)+floor(a/hashing_size)}function findIndexFromHash(e){return floor(e/100)+e%100*ceil(cWidth/hashing_size)}function generateHashSpace(){for(totalpoints=0,verticesCanvasLayer.clear(),verticesHashTable=[],i=0;i<=ceil(cWidth/hashing_size+1)*ceil(cHeight/hashing_size+1);i++)verticesHashTable.push([])}function updateHashSpace(e,a,s){var t=findIndexFromHash(hashCoordinate(e,a));if(1==s&&(verticesHashTable[t].push([e,a]),verticesCanvasLayer.ellipse(e,a,5,5),totalpoints++),0==s)for(i=0;i<verticesHashTable[t].length;i++)if(verticesHashTable[t][i][0]==e&&verticesHashTable[t][i][1]==a){verticesHashTable[t].splice(i,1),totalpoints--;verticesCanvasLayer.elt.getContext("2d").clearRect(e-5,a-5,10,10)}}function draw_all_points(e,a){for(e.fill(255),e.stroke(1),j=0;j<a.length;j++)for(k=0;k<a[j].length;k++)e.ellipse(a[j][k][0],a[j][k][1],5,5)}function clear_all_points(e){}function unique_vertex(e,a){for(var s=findIndexFromHash(hashCoordinate(e,a)),i=0;i<verticesHashTable[s].length;i++)if(verticesHashTable[s][i][0]==e&&verticesHashTable[s][i][1]==a)return!1;return!0}function keyPressed(e){if(32===keyCode)downloading=!0,downloading=!1;else if(68===keyCode)triangulate_and_display();else if(67===keyCode)if(!1===noColors?(noColors=!0,css_buttons.displayColor(!1)):(noColors=!1,css_buttons.displayColor(!0)),flowerEffect);else for(j=0;j<triangulations.length;j++)delaunayDisplay(triangulations[j],triangleCanvasLayer);else 80===keyCode?(mode=1,removeClassFromBrushes("active"),$("#pointBrush").addClass("active")):69===keyCode?(mode=3,removeClassFromBrushes("active"),$("#eraser").addClass("active")):66===keyCode?(mode=2,removeClassFromBrushes("active"),$("#lineBrush").addClass("active")):84===keyCode&&(mode=4,removeClassFromBrushes("active"),$("#triangleMove").addClass("active"))}function triangulate_and_display(){triangulize(),finishedColoring=!1,flowerEffect&&(flower_step=0,flowering=!0),image(img1,0,0,cWidth,cHeight),noColors=!1,css_buttons.displayColor(!0),displayPoints=!1,css_buttons.displayPoints(!1),loadPixels(),tColors=[],sTime=millis()}function mouseClicked(){if(!0===active_canvas&&mouseX<=cWidth&&mouseX>=0&&mouseY<=cHeight&&mouseY>=0){if(1==mode){var e=round(mouseX),a=round(mouseY);1==snapping&&(e-=e%snappingAccuracy,a-=a%snappingAccuracy),unique_vertex(e,a)&&updateHashSpace(e,a,!0)}if(mode,4===mode){var s=triangulations[0];for(k=0;k<s.length;k+=3)if(pointInTriangle(verticesHashTableFlat[s[k]][0],verticesHashTableFlat[s[k]][1],verticesHashTableFlat[s[k+1]][0],verticesHashTableFlat[s[k+1]][1],verticesHashTableFlat[s[k+2]][0],verticesHashTableFlat[s[k+2]][1],mouseX,mouseY))if(tColors[k]>=0)tColors[k]=-1;else if(-1==tColors[k]){var i=[0,0,0];i=averageColor(verticesHashTableFlat[s[k]][0],verticesHashTableFlat[s[k]][1],verticesHashTableFlat[s[k+1]][0],verticesHashTableFlat[s[k+1]][1],verticesHashTableFlat[s[k+2]][0],verticesHashTableFlat[s[k+2]][1],colorAccuracy),tColors[k]=i[0],tColors[k+1]=i[1],tColors[k+2]=i[2]}}recordVertices()}}function erase_vertices(e,a,s){for(var i=floor(round(e)/hashing_size)*hashing_size,t=floor(round(a)/hashing_size)*hashing_size,r=(findIndexFromHash(hashCoordinate(i,t)),[]),o=-ceil(s/hashing_size);o<=ceil(s/hashing_size);o++)for(var n=-ceil(s/hashing_size);n<=ceil(s/hashing_size);n++){var l=i+hashing_size*o,c=t+hashing_size*n;inCanvas(l,c)&&r.push(findIndexFromHash(hashCoordinate(l,c)))}var d=[];for(o=0;o<r.length;o++)for(n=0;n<verticesHashTable[r[o]].length;n++){var h=verticesHashTable[r[o]][n];squaredist(h[0],h[1],e,a)<=s*s&&d.push(h[0],h[1])}for(o=0;o<d.length;o+=2)updateHashSpace(d[o],d[o+1],!1)}function snapVertices(e){for(e||(e=20),in1=0;in1<verticesHashTable.length;in1++)for(in2=0;in2<verticesHashTable[in1].length;in2++){var a=!0,s=!0;verticesHashTable[in1][in2][0]==cWidth&&(a=!1),verticesHashTable[in1][in2][1]==cHeight&&(s=!1),a&&(verticesHashTable[in1][in2][0]%e<e/2?verticesHashTable[in1][in2][0]=verticesHashTable[in1][in2][0]-verticesHashTable[in1][in2][0]%e:verticesHashTable[in1][in2][0]=verticesHashTable[in1][in2][0]+20-verticesHashTable[in1][in2][0]%e),s&&(verticesHashTable[in1][in2][1]%e<e/2?verticesHashTable[in1][in2][1]=verticesHashTable[in1][in2][1]-verticesHashTable[in1][in2][1]%e:verticesHashTable[in1][in2][1]=verticesHashTable[in1][in2][1]+20-verticesHashTable[in1][in2][1]%e)}recordVertices(),verticesCanvasLayer.clear(),draw_all_points(verticesCanvasLayer,verticesHashTable)}function delaunayDisplay(e,a,s,i,t,r){var o=triangulatedVerticesFlat;if(s&&(o=s),0===flower_step&&i&&(uncoloredTriangleCanvasLayer=createGraphics(cWidth,cHeight),colorIn(),sTime=millis(),!0===displayImage?(a.image(img1,0,0,cWidth,cHeight),uncoloredTriangleCanvasLayer.image(img1,0,0,cWidth,cHeight)):(a.fill(255),a.rect(0,0,cWidth,cHeight),uncoloredTriangleCanvasLayer.fill(255),uncoloredTriangleCanvasLayer.rect(0,0,cWidth,cHeight)),a.fill(256,256,256),a.stroke(10,10,10),uncoloredTriangleCanvasLayer.fill(256,256,256),uncoloredTriangleCanvasLayer.stroke(10,10,10),o.length>0))for(var n=0;n<e.length;n+=3)construct_shape_from_vertices(o,a,e,n),construct_shape_from_vertices(o,uncoloredTriangleCanvasLayer,e,n);if(i){var l=1;for(r&&(l=r),n=3*t;n<3*t+3*l;n+=3)n<e.length&&(tColors[n]>=0?(a.fill(tColors[n],tColors[n+1],tColors[n+2]),a.stroke(tColors[n],tColors[n+1],tColors[n+2])):(a.fill(256,256,256),a.stroke(10,10,10)),o.length>0&&construct_shape_from_vertices(o,a,e,n))}else{!0===displayImage?a.image(img1,0,0,cWidth,cHeight):(a.fill(255),a.rect(0,0,cWidth,cHeight));var c,d;l=1;i?r&&(c=3*t+3*(l=r)):(d=0,c=e.length);for(n=d;n<c;n+=3)tColors[n]>=0&&0==noColors?(a.fill(tColors[n],tColors[n+1],tColors[n+2]),a.stroke(tColors[n],tColors[n+1],tColors[n+2])):1==noColors?(a.fill(256,256,256),a.stroke(10,10,10)):-1==tColors[n]?(a.noFill(),a.noStroke()):(a.fill(256,256,256),a.stroke(10,10,10)),o.length>0&&construct_shape_from_vertices(o,a,e,n)}}function construct_shape_from_vertices(e,a,s,i){if(0==displayMode)a.triangle(e[s[i]][0],e[s[i]][1],e[s[i+1]][0],e[s[i+1]][1],e[s[i+2]][0],e[s[i+2]][1]);else if(1==displayMode){var t=[e[s[i]][0],e[s[i+1]][0],e[s[i+2]][0]],r=[e[s[i]][1],e[s[i+1]][1],e[s[i+2]][1]],o=t[0],n=r[0],l=-1,c=-1;for(xi=0;xi<t.length;xi++)t[xi]<o&&(o=t[xi]),t[xi]>l&&(l=t[xi]),r[xi]<n&&(n=r[xi]),r[xi]>c&&(c=r[xi]);a.rect(o,n,l-o,c-n)}else if(2==displayMode){var d=circumcenter(e[s[i]][0],e[s[i]][1],e[s[i+1]][0],e[s[i+1]][1],e[s[i+2]][0],e[s[i+2]][1]),h=d[0],u=d[1],v=2*sqrt(squaredist(e[s[i]][0],e[s[i]][1],h,u));a.ellipse(h,u,v,v)}else if(3==displayMode)a.triangle(e[s[i]][0],e[s[i]][1],e[s[i+1]][0],e[s[i+1]][1],e[s[i+2]][0],e[s[i+2]][1]),a.triangle(e[s[i]][0]+random(-sd,sd),e[s[i]][1]+random(-sd,sd),e[s[i+1]][0]+random(-sd,sd),e[s[i+1]][1]+random(-sd,sd),e[s[i+2]][0]+random(-sd,sd),e[s[i+2]][1]+random(-sd,sd));else if(4==displayMode){t=[e[s[i]][0],e[s[i+1]][0],e[s[i+2]][0]],r=[e[s[i]][1],e[s[i+1]][1],e[s[i+2]][1]],o=t[0],n=r[0],l=-1,c=-1;for(xi=0;xi<t.length;xi++)t[xi]<o&&(o=t[xi]),t[xi]>l&&(l=t[xi]),r[xi]<n&&(n=r[xi]),r[xi]>c&&(c=r[xi]);a.rect(o,n,l-o,c-n),a.rect(o+random(-sd,sd),n+random(-sd,sd),l-o+random(-sd,sd),c-n+random(-sd,sd))}}function circumcenter(e,a,s,i,t,r){var o=s-e,n=i-a,l=t-e,c=r-a,d=o*o+n*n,h=l*l+c*c,u=o*c-n*l;return[e+.5*(c*d-n*h)/u,a+.5*(o*h-l*d)/u]}function loadData(e){for(null===e&&alert("No recently saved data"),triangulations=e[0],tColors=e[1],verticesHashTable=e[2],verticesHashTableFlat=e[3],cWidth=e[4],cHeight=e[5],myCanvas=resizeCanvas(cWidth,cHeight),$("#gamedisplay").css("width",cWidth),$("#gamedisplay").css("margin-left",-cWidth/2),triangulize(),displayPoints=!0,css_buttons.displayPoints(!0),j=0;j<triangulations.length;j++)delaunayDisplay(triangulations[j],triangleCanvasLayer);recordVertices(),verticesCanvasLayer.clear(),draw_all_points(verticesCanvasLayer,verticesHashTable)}function saveData(e){var a="art1";e&&(a=e);var s=[triangulations.slice(),tColors.slice(),verticesHashTable.slice(),verticesHashTableFlat.slice(),cWidth,cHeight];localStorage.setItem(a,JSON.stringify(s))}function expandVertex(e,a){return[e[0]*a,e[1]*a]}function lineAngle(e,a,s,i){var t=0;if(s-e>=0)t=0,i-a>=0&&(t=360);else t=180;return-atan((i-a)/(s-e))+t}function expandImage(e,a){var s=cWidth*e,i=cHeight*e;sd*=e,downloadcanvas=createGraphics(s,i);for(var t=JSON.parse(JSON.stringify(triangulatedVerticesFlat)),r=0;r<t.length;r++){var o=expandVertex(t[r],e);t[r]=o}for(downloadcanvas.noSmooth(),j=0;j<triangulations.length;j++)delaunayDisplay(triangulations[j],downloadcanvas,t);if(1==a){downloading=!0,downloadcanvas.elt.id="downloadthiscanvas";var n=document.getElementById("downloadthiscanvas");n.getContext("2d");n.toBlob(function(e){saveAs(e,"PolyArt.png")}),$("#downloadthiscanvas").remove(),downloading=!1,console.log("Finished downloading")}sd/=e}function triangulize(){var e;verticesHashTableFlat=verticesHashTable.reduce(function(e,a){return e.concat(a)}),e=Delaunator.from(verticesHashTableFlat),stepD=0;var a=e.triangles;triangulations[0]=a,displayTriangulation=!0,css_buttons.displayTriangulation(!0),stepD=0,triangulatedVerticesFlat=JSON.parse(JSON.stringify(verticesHashTableFlat))}function fget(e,a){var s=((a=parseInt(a.toFixed(0)))*d*cWidth+e)*d*4;return[pixels[s],pixels[s+1],pixels[s+2],pixels[s+3]]}function inCanvas(e,a){return!(e>cWidth||e<0||a>cHeight||a<0)}function sign(e,a,s,i,t,r){return(e-t)*(i-r)-(s-t)*(a-r)}function pointInTriangle(e,a,s,i,t,r,o,n){return bc1=sign(o,n,e,a,s,i)<0,bc2=sign(o,n,s,i,t,r)<0,bc3=sign(o,n,t,r,e,a)<0,bc1==bc2&&bc2==bc3}function averageColor(e,a,s,t,r,o,n){var l=[e,s,r],c=[a,t,o],d=l.reduce(function(e,a){return a<=e?a:e}),h=l.reduce(function(e,a){return a>=e?a:e}),u=c.reduce(function(e,a){return a<=e?a:e}),v=c.reduce(function(e,a){return a>=e?a:e});if(1==quickColor)return quickAverageColor(e,a,s,t,r,o);var g=0,f=0,p=0,m=0;for(i=0;i<v-u;i+=n)for(j=0;j<h-d;j+=n)if(pointInTriangle(e,a,s,t,r,o,d+j,u+i)){var C=fget(d+j,u+i);g+=C[0],f+=C[1],p+=C[2],m+=1}return 0==m?quickAverageColor(e,a,s,t,r,o):[g/m,f/m,p/m]}function quickAverageColor(e,a,s,i,t,r){var o=fget(e,a),n=fget(s,i),l=fget(t,r);return[(o[0]+n[0]+l[0])/3,(o[1]+n[1]+l[1])/3,(o[2]+n[2]+l[2])/3]}function squaredist(e,a,s,i){return(s-e)*(s-e)+(i-a)*(i-a)}function construct_css_buttons(){this.displayPoints=function(e){!0===e?($("#displayPoints").removeClass("active"),$("#displayPoints").html("Hide<br>Points")):($("#displayPoints").addClass("active"),$("#displayPoints").html("Show<br>Points"))},this.displayColor=function(e){!0===e?($("#displayColor").removeClass("active"),$("#displayColor").html("Hide<br>Colors")):($("#displayColor").html("Show<br>Colors"),$("#displayColor").addClass("active"))},this.displayTriangulation=function(e){!0===e?($("#displayTriangulation").html("Hide<br>Triangles<br>"),$("#displayTriangulation").removeClass("active")):($("#displayTriangulation").html("Show<br>Triangles<br>"),$("#displayTriangulation").addClass("active"))},this.displayImage=function(e){!0===e?($("#displayImage").removeClass("active"),$("#displayImage").html("Hide<br>Image")):($("#displayImage").html("Show<br>Image"),$("#displayImage").addClass("active"))}}function undo(){indexPos-++stepBackNum<=0||stepBackNum>=max_undo-1||stepBackNum>=maxStepBackDist?($("#undo").addClass("disabled"),$("#undo").css("cursor","not-allowed"),$("#redo").removeClass("disabled"),$("#redo").css("cursor","pointer")):($("#undo").removeClass("disabled"),$("#undo").css("cursor","pointer"),$("#redo").removeClass("disabled"),$("#redo").css("cursor","pointer")),indexPos-stepBackNum<0||stepBackNum>max_undo-1||stepBackNum>maxStepBackDist?stepBackNum--:(undoState=1,verticesHashTable=JSON.parse(JSON.stringify(storedVertices[(indexPos-stepBackNum)%max_undo][0])),totalpoints=storedVertices[(indexPos-stepBackNum)%max_undo][1],verticesHashTableFlat=verticesHashTable.reduce(function(e,a){return e.concat(a)}),verticesCanvasLayer.clear(),draw_all_points(verticesCanvasLayer,verticesHashTable))}function redo(){if(--stepBackNum<=0?($("#redo").addClass("disabled"),$("#redo").css("cursor","not-allowed"),$("#undo").removeClass("disabled"),$("#undo").css("cursor","pointer")):($("#redo").removeClass("disabled"),$("#redo").css("cursor","pointer"),$("#undo").removeClass("disabled"),$("#undo").css("cursor","pointer")),stepBackNum<0)return stepBackNum++,void(undoState=0);verticesHashTable=JSON.parse(JSON.stringify(storedVertices[(indexPos-stepBackNum)%max_undo][0])),totalpoints=storedVertices[(indexPos-stepBackNum)%max_undo][1],verticesHashTableFlat=verticesHashTable.reduce(function(e,a){return e.concat(a)}),verticesCanvasLayer.clear(),draw_all_points(verticesCanvasLayer,verticesHashTable)}function recordVertices(){0==undoState?(indexPos++,storedVertices[indexPos%max_undo][0]=JSON.parse(JSON.stringify(verticesHashTable)),storedVertices[indexPos%max_undo][1]=totalpoints,indexPos>=4*max_undo&&(indexPos=indexPos%max_undo+max_undo),maxStepBackDist>=50||maxStepBackDist++,$("#undo").removeClass("disabled"),$("#undo").css("cursor","pointer"),$("#redo").addClass("disabled"),$("#redo").css("cursor","not-allowed")):($("#redo").addClass("disabled"),$("#redo").css("cursor","not-allowed"),$("#undo").removeClass("disabled"),$("#undo").css("cursor","pointer"),indexPos-=stepBackNum,maxStepBackDist=max_undo-stepBackNum,stepBackNum=0,undoState=0,indexPos++,storedVertices[indexPos%max_undo][0]=JSON.parse(JSON.stringify(verticesHashTable)),storedVertices[indexPos%max_undo][1]=totalpoints)}function resize_poly_canvas(e){cWidth=floor(cWidth*e),cHeight=floor(cHeight*e),triangleCanvasLayer=createGraphics(cWidth,cHeight),verticesCanvasLayer=createGraphics(cWidth,cHeight),resizeCanvas(cWidth,cHeight),$("#gamedisplay").css("width",cWidth),$("#gamedisplay").css("margin-left",-cWidth/2),cWidth>.9*window.innerWidth?$("body").width(cWidth+100):$("body").css("width","auto"),verticesHashTableFlat=verticesHashTable.reduce(function(e,a){return e.concat(a)});var a=JSON.parse(JSON.stringify(verticesHashTableFlat));generateHashSpace();for(var s=0;s<a.length;s++){var i=expandVertex(a[s],e);a[s]=i,updateHashSpace(floor(i[0]),floor(i[1]),!0)}completedFilters=!1}var downloadcanvas,testCanvas,origcWidth,origcHeight,hashing_size=50,sd=15,css_buttons=new construct_css_buttons,maxStepBackDist=0,indexPos=-1,stepBackNum=0,undoState=0,canvasScale=1;