function hashCoordinate(e,s){return 100*floor(e/hashing_size)+floor(s/hashing_size)}function findIndexFromHash(e){return floor(e/100)+e%100*ceil(cWidth/hashing_size)}function generateHashSpace(){for(totalpoints=0,verticesCanvasLayer.clear(),verticesHashTable=[],i=0;i<=ceil(cWidth/hashing_size+1)*ceil(cHeight/hashing_size+1);i++)verticesHashTable.push([])}function updateHashSpace(e,s,a){var t=findIndexFromHash(hashCoordinate(e,s));if(1==a&&(verticesHashTable[t].push([e,s]),verticesCanvasLayer.ellipse(e,s,5,5),totalpoints++),0==a)for(i=0;i<verticesHashTable[t].length;i++)if(verticesHashTable[t][i][0]==e&&verticesHashTable[t][i][1]==s){verticesHashTable[t].splice(i,1),totalpoints--;verticesCanvasLayer.elt.getContext("2d").clearRect(e-5,s-5,10,10)}}function draw_all_points(e,s){for(e.fill(255),e.stroke(1),j=0;j<s.length;j++)for(k=0;k<s[j].length;k++)e.ellipse(s[j][k][0],s[j][k][1],5,5)}function clear_all_points(e){}function unique_vertex(e,s){for(var a=findIndexFromHash(hashCoordinate(e,s)),i=0;i<verticesHashTable[a].length;i++)if(verticesHashTable[a][i][0]==e&&verticesHashTable[a][i][1]==s)return!1;return!0}function keyPressed(e){if(32===keyCode)downloading=!0,downloading=!1;else if(68===keyCode)triangulate_and_display();else if(67===keyCode)if(!1===noColors?(noColors=!0,css_buttons.displayColor(!1)):(noColors=!1,css_buttons.displayColor(!0)),flowerEffect);else for(j=0;j<triangulations.length;j++)delaunayDisplay(triangulations[j],triangleCanvasLayer);else 80===keyCode?(mode=1,removeClassFromBrushes("active"),$("#pointBrush").addClass("active")):69===keyCode?(mode=3,removeClassFromBrushes("active"),$("#eraser").addClass("active")):66===keyCode?(mode=2,removeClassFromBrushes("active"),$("#lineBrush").addClass("active")):84===keyCode&&(mode=4,removeClassFromBrushes("active"),$("#triangleMove").addClass("active"))}function triangulate_and_display(){triangulize(),finishedColoring=!1,flowerEffect&&(flower_step=0,flowering=!0),image(img1,0,0,cWidth,cHeight),noColors=!1,css_buttons.displayColor(!0),displayPoints=!1,css_buttons.displayPoints(!1),loadPixels(),tColors=[],sTime=millis()}function mouseClicked(){if(!0===active_canvas&&mouseX<=cWidth&&mouseX>=0&&mouseY<=cHeight&&mouseY>=0){if(1==mode){var e=round(mouseX),s=round(mouseY);1==snapping&&(e-=e%snappingAccuracy,s-=s%snappingAccuracy),unique_vertex(e,s)&&updateHashSpace(e,s,!0)}if(mode,4===mode){var a=triangulations[0];for(k=0;k<a.length;k+=3)if(pointInTriangle(verticesHashTableFlat[a[k]][0],verticesHashTableFlat[a[k]][1],verticesHashTableFlat[a[k+1]][0],verticesHashTableFlat[a[k+1]][1],verticesHashTableFlat[a[k+2]][0],verticesHashTableFlat[a[k+2]][1],mouseX,mouseY))if(tColors[k]>=0)tColors[k]=-1;else if(-1==tColors[k]){var i=[0,0,0];i=averageColor(verticesHashTableFlat[a[k]][0],verticesHashTableFlat[a[k]][1],verticesHashTableFlat[a[k+1]][0],verticesHashTableFlat[a[k+1]][1],verticesHashTableFlat[a[k+2]][0],verticesHashTableFlat[a[k+2]][1],colorAccuracy),tColors[k]=i[0],tColors[k+1]=i[1],tColors[k+2]=i[2]}}recordVertices()}}function erase_vertices(e,s,a){for(var i=floor(round(e)/hashing_size)*hashing_size,t=floor(round(s)/hashing_size)*hashing_size,r=(findIndexFromHash(hashCoordinate(i,t)),[]),o=-ceil(a/hashing_size);o<=ceil(a/hashing_size);o++)for(var n=-ceil(a/hashing_size);n<=ceil(a/hashing_size);n++){var l=i+hashing_size*o,c=t+hashing_size*n;inCanvas(l,c)&&r.push(findIndexFromHash(hashCoordinate(l,c)))}var d=[];for(o=0;o<r.length;o++)for(n=0;n<verticesHashTable[r[o]].length;n++){var u=verticesHashTable[r[o]][n];squaredist(u[0],u[1],e,s)<=a*a&&d.push(u[0],u[1])}for(o=0;o<d.length;o+=2)updateHashSpace(d[o],d[o+1],!1)}function snapVertices(e){for(e||(e=20),in1=0;in1<verticesHashTable.length;in1++)for(in2=0;in2<verticesHashTable[in1].length;in2++){var s=!0,a=!0;verticesHashTable[in1][in2][0]==cWidth&&(s=!1),verticesHashTable[in1][in2][1]==cHeight&&(a=!1),s&&(verticesHashTable[in1][in2][0]%e<e/2?verticesHashTable[in1][in2][0]=verticesHashTable[in1][in2][0]-verticesHashTable[in1][in2][0]%e:verticesHashTable[in1][in2][0]=verticesHashTable[in1][in2][0]+20-verticesHashTable[in1][in2][0]%e),a&&(verticesHashTable[in1][in2][1]%e<e/2?verticesHashTable[in1][in2][1]=verticesHashTable[in1][in2][1]-verticesHashTable[in1][in2][1]%e:verticesHashTable[in1][in2][1]=verticesHashTable[in1][in2][1]+20-verticesHashTable[in1][in2][1]%e)}recordVertices(),verticesCanvasLayer.clear(),draw_all_points(verticesCanvasLayer,verticesHashTable)}function delaunayDisplay(e,s,a,i,t,r){var o=triangulatedVerticesFlat;if(a&&(o=a),0===flower_step&&i&&(uncoloredTriangleCanvasLayer=createGraphics(cWidth,cHeight),colorIn(),sTime=millis(),!0===displayImage?(s.image(img1,0,0,cWidth,cHeight),uncoloredTriangleCanvasLayer.image(img1,0,0,cWidth,cHeight)):(s.fill(255),s.rect(0,0,cWidth,cHeight),uncoloredTriangleCanvasLayer.fill(255),uncoloredTriangleCanvasLayer.rect(0,0,cWidth,cHeight)),s.fill(256,256,256),s.stroke(10,10,10),uncoloredTriangleCanvasLayer.fill(256,256,256),uncoloredTriangleCanvasLayer.stroke(10,10,10),o.length>0))for(var n=0;n<e.length;n+=3)construct_shape_from_vertices(o,s,e,n),construct_shape_from_vertices(o,uncoloredTriangleCanvasLayer,e,n);if(i){var l=1;for(r&&(l=r),n=3*t;n<3*t+3*l;n+=3)n<e.length&&(tColors[n]>=0?(s.fill(tColors[n],tColors[n+1],tColors[n+2]),s.stroke(tColors[n],tColors[n+1],tColors[n+2])):(s.fill(256,256,256),s.stroke(10,10,10)),o.length>0&&construct_shape_from_vertices(o,s,e,n))}else{!0===displayImage?s.image(img1,0,0,cWidth,cHeight):(s.fill(255),s.rect(0,0,cWidth,cHeight));var c,d;l=1;i?r&&(c=3*t+3*(l=r)):(d=0,c=e.length);for(n=d;n<c;n+=3)tColors[n]>=0&&0==noColors?(s.fill(tColors[n],tColors[n+1],tColors[n+2]),s.stroke(tColors[n],tColors[n+1],tColors[n+2])):1==noColors?(s.fill(256,256,256),s.stroke(10,10,10)):-1==tColors[n]?(s.noFill(),s.noStroke()):(s.fill(256,256,256),s.stroke(10,10,10)),o.length>0&&construct_shape_from_vertices(o,s,e,n)}}function construct_shape_from_vertices(e,s,a,i){if(0==displayMode)s.triangle(e[a[i]][0],e[a[i]][1],e[a[i+1]][0],e[a[i+1]][1],e[a[i+2]][0],e[a[i+2]][1]);else if(1==displayMode){var t=[e[a[i]][0],e[a[i+1]][0],e[a[i+2]][0]],r=[e[a[i]][1],e[a[i+1]][1],e[a[i+2]][1]],o=t[0],n=r[0],l=-1,c=-1;for(xi=0;xi<t.length;xi++)t[xi]<o&&(o=t[xi]),t[xi]>l&&(l=t[xi]),r[xi]<n&&(n=r[xi]),r[xi]>c&&(c=r[xi]);s.rect(o,n,l-o,c-n)}else if(2==displayMode){var d=circumcenter(e[a[i]][0],e[a[i]][1],e[a[i+1]][0],e[a[i+1]][1],e[a[i+2]][0],e[a[i+2]][1]),u=d[0],h=d[1],v=2*sqrt(squaredist(e[a[i]][0],e[a[i]][1],u,h));s.ellipse(u,h,v,v)}else if(3==displayMode)s.triangle(e[a[i]][0],e[a[i]][1],e[a[i+1]][0],e[a[i+1]][1],e[a[i+2]][0],e[a[i+2]][1]),s.triangle(e[a[i]][0]+random(-sd,sd),e[a[i]][1]+random(-sd,sd),e[a[i+1]][0]+random(-sd,sd),e[a[i+1]][1]+random(-sd,sd),e[a[i+2]][0]+random(-sd,sd),e[a[i+2]][1]+random(-sd,sd));else if(4==displayMode){t=[e[a[i]][0],e[a[i+1]][0],e[a[i+2]][0]],r=[e[a[i]][1],e[a[i+1]][1],e[a[i+2]][1]],o=t[0],n=r[0],l=-1,c=-1;for(xi=0;xi<t.length;xi++)t[xi]<o&&(o=t[xi]),t[xi]>l&&(l=t[xi]),r[xi]<n&&(n=r[xi]),r[xi]>c&&(c=r[xi]);s.rect(o,n,l-o,c-n),s.rect(o+random(-sd,sd),n+random(-sd,sd),l-o+random(-sd,sd),c-n+random(-sd,sd))}}function circumcenter(e,s,a,i,t,r){var o=a-e,n=i-s,l=t-e,c=r-s,d=o*o+n*n,u=l*l+c*c,h=o*c-n*l;return[e+.5*(c*d-n*u)/h,s+.5*(o*u-l*d)/h]}function loadData(e){for(null===e&&alert("No recently saved data"),triangulations=e[0],tColors=e[1],verticesHashTable=e[2],verticesHashTableFlat=e[3],cWidth=e[4],cHeight=e[5],myCanvas=resizeCanvas(cWidth,cHeight),$("#gamedisplay").css("width",cWidth),$("#gamedisplay").css("margin-left",-cWidth/2),triangulize(),displayPoints=!0,css_buttons.displayPoints(!0),j=0;j<triangulations.length;j++)delaunayDisplay(triangulations[j],triangleCanvasLayer);recordVertices()}function saveData(e){var s="art1";e&&(s=e);var a=[triangulations.slice(),tColors.slice(),verticesHashTable.slice(),verticesHashTableFlat.slice(),cWidth,cHeight];localStorage.setItem(s,JSON.stringify(a))}function expandVertex(e,s){return[e[0]*s,e[1]*s]}function lineAngle(e,s,a,i){var t=0;if(a-e>=0)t=0,i-s>=0&&(t=360);else t=180;return-atan((i-s)/(a-e))+t}function expandImage(e,s){var a=cWidth*e,i=cHeight*e;sd*=e,downloadcanvas=createGraphics(a,i);for(var t=JSON.parse(JSON.stringify(triangulatedVerticesFlat)),r=0;r<t.length;r++){var o=expandVertex(t[r],e);t[r]=o}for(downloadcanvas.noSmooth(),j=0;j<triangulations.length;j++)delaunayDisplay(triangulations[j],downloadcanvas,t);if(1==s){downloading=!0,downloadcanvas.elt.id="downloadthiscanvas";var n=document.getElementById("downloadthiscanvas");n.getContext("2d");n.toBlob(function(e){saveAs(e,"PolyArt.png")}),$("#downloadthiscanvas").remove(),downloading=!1,console.log("Finished downloading")}sd/=e}function triangulize(){var e;verticesHashTableFlat=verticesHashTable.reduce(function(e,s){return e.concat(s)}),e=Delaunator.from(verticesHashTableFlat),stepD=0;var s=e.triangles;triangulations[0]=s,displayTriangulation=!0,css_buttons.displayTriangulation(!0),stepD=0,triangulatedVerticesFlat=JSON.parse(JSON.stringify(verticesHashTableFlat))}function fget(e,s){var a=((s=parseInt(s.toFixed(0)))*d*cWidth+e)*d*4;return[pixels[a],pixels[a+1],pixels[a+2],pixels[a+3]]}function inCanvas(e,s){return!(e>cWidth||e<0||s>cHeight||s<0)}function sign(e,s,a,i,t,r){return(e-t)*(i-r)-(a-t)*(s-r)}function pointInTriangle(e,s,a,i,t,r,o,n){return bc1=sign(o,n,e,s,a,i)<0,bc2=sign(o,n,a,i,t,r)<0,bc3=sign(o,n,t,r,e,s)<0,bc1==bc2&&bc2==bc3}function averageColor(e,s,a,t,r,o,n){var l=[e,a,r],c=[s,t,o],d=l.reduce(function(e,s){return s<=e?s:e}),u=l.reduce(function(e,s){return s>=e?s:e}),h=c.reduce(function(e,s){return s<=e?s:e}),v=c.reduce(function(e,s){return s>=e?s:e});if(1==quickColor)return quickAverageColor(e,s,a,t,r,o);var g=0,f=0,p=0,m=0;for(i=0;i<v-h;i+=n)for(j=0;j<u-d;j+=n)if(pointInTriangle(e,s,a,t,r,o,d+j,h+i)){var C=fget(d+j,h+i);g+=C[0],f+=C[1],p+=C[2],m+=1}return 0==m?quickAverageColor(e,s,a,t,r,o):[g/m,f/m,p/m]}function quickAverageColor(e,s,a,i,t,r){var o=fget(e,s),n=fget(a,i),l=fget(t,r);return[(o[0]+n[0]+l[0])/3,(o[1]+n[1]+l[1])/3,(o[2]+n[2]+l[2])/3]}function squaredist(e,s,a,i){return(a-e)*(a-e)+(i-s)*(i-s)}function construct_css_buttons(){this.displayPoints=function(e){!0===e?($("#displayPoints").removeClass("active"),$("#displayPoints").html("Hide<br>Points")):($("#displayPoints").addClass("active"),$("#displayPoints").html("Show<br>Points"))},this.displayColor=function(e){!0===e?($("#displayColor").removeClass("active"),$("#displayColor").html("Hide<br>Colors")):($("#displayColor").html("Show<br>Colors"),$("#displayColor").addClass("active"))},this.displayTriangulation=function(e){!0===e?($("#displayTriangulation").html("Hide<br>Triangles<br>"),$("#displayTriangulation").removeClass("active")):($("#displayTriangulation").html("Show<br>Triangles<br>"),$("#displayTriangulation").addClass("active"))},this.displayImage=function(e){!0===e?($("#displayImage").removeClass("active"),$("#displayImage").html("Hide<br>Image")):($("#displayImage").html("Show<br>Image"),$("#displayImage").addClass("active"))}}function undo(){indexPos-++stepBackNum<=0||stepBackNum>=max_undo-1||stepBackNum>=maxStepBackDist?($("#undo").addClass("disabled"),$("#undo").css("cursor","not-allowed"),$("#redo").removeClass("disabled"),$("#redo").css("cursor","pointer")):($("#undo").removeClass("disabled"),$("#undo").css("cursor","pointer"),$("#redo").removeClass("disabled"),$("#redo").css("cursor","pointer")),indexPos-stepBackNum<0||stepBackNum>max_undo-1||stepBackNum>maxStepBackDist?stepBackNum--:(undoState=1,verticesHashTable=JSON.parse(JSON.stringify(storedVertices[(indexPos-stepBackNum)%max_undo][0])),totalpoints=storedVertices[(indexPos-stepBackNum)%max_undo][1],verticesHashTableFlat=verticesHashTable.reduce(function(e,s){return e.concat(s)}))}function redo(){if(--stepBackNum<=0?($("#redo").addClass("disabled"),$("#redo").css("cursor","not-allowed"),$("#undo").removeClass("disabled"),$("#undo").css("cursor","pointer")):($("#redo").removeClass("disabled"),$("#redo").css("cursor","pointer"),$("#undo").removeClass("disabled"),$("#undo").css("cursor","pointer")),stepBackNum<0)return stepBackNum++,void(undoState=0);verticesHashTable=JSON.parse(JSON.stringify(storedVertices[(indexPos-stepBackNum)%max_undo][0])),totalpoints=storedVertices[(indexPos-stepBackNum)%max_undo][1],verticesHashTableFlat=verticesHashTable.reduce(function(e,s){return e.concat(s)})}function recordVertices(){0==undoState?(indexPos++,storedVertices[indexPos%max_undo][0]=JSON.parse(JSON.stringify(verticesHashTable)),storedVertices[indexPos%max_undo][1]=totalpoints,indexPos>=4*max_undo&&(indexPos=indexPos%max_undo+max_undo),maxStepBackDist>=50||maxStepBackDist++,$("#undo").removeClass("disabled"),$("#undo").css("cursor","pointer"),$("#redo").addClass("disabled"),$("#redo").css("cursor","not-allowed")):($("#redo").addClass("disabled"),$("#redo").css("cursor","not-allowed"),$("#undo").removeClass("disabled"),$("#undo").css("cursor","pointer"),indexPos-=stepBackNum,maxStepBackDist=max_undo-stepBackNum,stepBackNum=0,undoState=0,indexPos++,storedVertices[indexPos%max_undo][0]=JSON.parse(JSON.stringify(verticesHashTable)),storedVertices[indexPos%max_undo][1]=totalpoints)}function resize_poly_canvas(e){cWidth=floor(cWidth*e),cHeight=floor(cHeight*e),triangleCanvasLayer=createGraphics(cWidth,cHeight),verticesCanvasLayer=createGraphics(cWidth,cHeight),resizeCanvas(cWidth,cHeight),$("#gamedisplay").css("width",cWidth),$("#gamedisplay").css("margin-left",-cWidth/2),cWidth>.9*window.innerWidth?$("body").width(cWidth+100):$("body").css("width","auto"),verticesHashTableFlat=verticesHashTable.reduce(function(e,s){return e.concat(s)});var s=JSON.parse(JSON.stringify(verticesHashTableFlat));generateHashSpace();for(var a=0;a<s.length;a++){var i=expandVertex(s[a],e);s[a]=i,updateHashSpace(floor(i[0]),floor(i[1]),!0)}completedFilters=!1}var downloadcanvas,testCanvas,origcWidth,origcHeight,hashing_size=50,sd=15,css_buttons=new construct_css_buttons,maxStepBackDist=0,indexPos=-1,stepBackNum=0,undoState=0,canvasScale=1;